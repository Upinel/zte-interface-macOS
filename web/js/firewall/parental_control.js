define(["jquery","knockout","config/config","service","underscore"],function(e,i,t,s,c){function a(){function t(e,i){showLoading(),s.addChildGroup(i,function(i){a.fetchChildGroupList(function(){a.fetchAttachedDevices(function(){hideLoading(),e&&s.logout({},function(){window.location="index.html"})})})},function(e){errorOverlay()})}var a=this,_=s.getHostNameList({}).devices;a.currentPage=i.observable(l.MAIN),a.pages=l,a.currentUserInChildGroup=i.observable(!0),a.childGroupList=i.observable([]),a.childGroupMac=i.computed(function(){return c.map(a.childGroupList(),function(e){return e.mac})}),a.fetchChildGroupList=function(i){s.childGroupList({},function(t){a.currentUserInChildGroup(s.checkCurrentUserInChildGroup(t.devices).result),a.childGroupList([]),c.map(t.devices,function(e,i){e.idx=i,e.hostname=m.getHostName(e.hostname,e.mac,_)}),a.childGroupList(t.devices),c.isFunction(i)&&i.apply(this),e("#pc_children_group_form").translate()})},a.fetchChildGroupList(),a.childAccessTimeList=i.observable([]),a.oriChildAccessTimeList=[],a.fetchChildAccessTimeList=function(i){s.getChildMacRuleInfo(i,function(t){hideLoading(),a.childAccessTimeList([]),a.childAccessTimeList(d(t.child_mac_rule_info,i.mac_addr)),a.oriChildAccessTimeList=d(t.child_mac_rule_info,i.mac_addr),e("#pc_page2").translate()})},a.attachedDevices=i.observable([]),a.manageHandler=function(i){a.currentPage(l.MANAGE),showLoading();var t={mac_addr:i.mac};a.fetchChildAccessTimeList(t),setTimeout(function(){e("#childAccessTimeFrm input[type='text']").each(function(i,t){e("#access_time_startHour_"+i).rules("add",{range:[0,23],accessTimeCompare:!0}),e("#access_time_startMinute_"+i).rules("add",{range:[0,59],accessTimeCompare:!0}),e("#access_time_endHour_"+i).rules("add",{range:[0,23],accessTimeCompare:!0}),e("#access_time_endMinute_"+i).rules("add",{range:[0,59],accessTimeCompare:!0})})},1e3)},a.fetchAttachedDevices=function(i){var t=[],d=0;s.getCurrentlyAttachedDevicesInfo({},function(s){d++;var n=c.map(s.attachedDevices,function(e){return e.idx=c.uniqueId("wireless_"),e.hostName=m.getHostName(e.hostName,e.macAddress,_),e.inChildGroup=c.contains(a.childGroupMac(),e.macAddress),e});1==d?t=n:(a.attachedDevices(c.flatten([t,n])),c.isFunction(i)&&i.apply(this),e("#pc_children_group_form").translate())}),s.getAttachedCableDevices({},function(s){d++;var n=c.map(s.attachedDevices,function(e){return e.idx=c.uniqueId("wireless_"),e.hostName=m.getHostName(e.hostName,e.macAddress,_),e.inChildGroup=c.contains(a.childGroupMac(),e.macAddress),e});1==d?t=n:(a.attachedDevices(c.flatten([t,n])),c.isFunction(i)&&i.apply(this),e("#pc_children_group_form").translate())})},addInterval(function(){a.currentPage()==l.MAIN&&a.fetchAttachedDevices()},3e3),i.computed(function(){a.attachedDevices(),a.childGroupList()}).extend({notify:"always",throttle:300}),a.backToMainHandler=function(){a.currentPage()==l.MANAGE?a.currentPage(l.MAIN):window.location.hash="#home"},a.addChildGroupHandler=function(e){if(s.childGroupList().devices.length>=10)return showAlert("kids_devices_max"),!1;s.getCurretnMAC()==e.macAddress?showConfirm("parental_add_self",function(){t(!0,e)}):t(!1,e)},a.removeChildGroupHandler=function(e){showLoading(),s.removeChildGroup(e,function(e){a.fetchChildGroupList(function(){a.fetchAttachedDevices(function(){hideLoading()})})},function(e){errorOverlay()}),s.removeChildMacRule(e,function(e){},function(e){})},a.dealElement=function(i,t){i?(e("#edit_btn_"+t+",#hostname_txt_"+t).hide(),e("#save_btn_"+t+",#cancel_btn_"+t+",#hostname_input_"+t).show()):(e("#edit_btn_"+t+",#hostname_txt_"+t).show(),e("#save_btn_"+t+",#cancel_btn_"+t+",#hostname_input_"+t).hide())},a.editHostNameHandler=function(i){return e("#hostname_input_"+i.idx).val(i.hostname),a.dealElement(!0,i.idx),!1},a.saveHostNameHandler=function(i){var t=e("#hostname_input_"+i.idx),c=e.trim(t.val());if(""==c){e(".promptErrorLabel","#confirm-message-container").text(e.i18n.prop("required"));var d=t.closest("td").addClass("has-error");return addTimeout(function(){d.removeClass("has-error")},5e3),showAlert("required"),!1}if(/[\*\$\[&:,;<>'"\\`\#\+\]ï¿¥]{1,32}/.test(c))return showAlert("modify_hostname_invalid"),!1;showLoading(),i.hostname=c,s.editHostName(i,function(){s.getHostNameList({},function(e){_=e.devices,a.fetchChildGroupList(function(){hideLoading()}),a.fetchAttachedDevices()})},function(){errorOverlay()})},a.cancelEditHostNameHandler=function(e){a.dealElement(!1,e.idx)},a.editChildAccessTimeHandler=function(i){return e("#access_time_startHour_"+i.idx).val(i.startHour),e("#access_time_startMinute_"+i.idx).val(i.startMinute),e("#access_time_endHour_"+i.idx).val(i.endHour),e("#access_time_endMinute_"+i.idx).val(i.endMinute),e("#access_time_txt_"+i.idx).hide(),e("#access_time_inputDiv_"+i.idx).show(),e("#access_time_txtBtnDiv_"+i.idx).hide(),e("#access_time_editBtnDiv_"+i.idx).show(),e("#access_week_txt_"+i.idx).hide(),e("#access_week_edit_"+i.idx).show(),e("td","#access_week_tr_"+i.idx).each(function(t,s){6==t?t=0:t+=1,i.week[t]?e(this).addClass("wmSelectedChild"):e(this).removeClass("wmSelectedChild")}),!1},a.removeChildAccessTimeHandler=function(e){showLoading(),s.getChildMacRuleInfo({mac_addr:a.oriChildAccessTimeList.mac_address},function(i){var t=i.child_mac_rule_info.split(";");t[e.idx+1]="";for(var c="",d=0;d<t.length;d++)""!=t[d]&&(c=""==c?t[d]:c+";"+t[d]);var n={};n.mac_addr=a.oriChildAccessTimeList.mac_address,0==e.idx&&1==a.oriChildAccessTimeList.length?n.child_mac_rule_info="":n.child_mac_rule_info=c+";",s.updateChildAccessTimeRule(n,function(){a.fetchChildAccessTimeList({mac_addr:a.oriChildAccessTimeList.mac_address},function(){hideLoading(),successOverlay()})},function(){errorOverlay()})})},a.discardChildAccessTimeHandler=function(i){clearValidateMsg("#childAccessTimeFrm"),e("#access_time_txt_"+i.idx).show(),e("#access_time_inputDiv_"+i.idx).hide(),e("#access_time_txtBtnDiv_"+i.idx).show(),e("#access_time_editBtnDiv_"+i.idx).hide(),e("#access_week_txt_"+i.idx).show(),e("#access_week_edit_"+i.idx).hide();var t={mac_addr:a.oriChildAccessTimeList.mac_address};a.fetchChildAccessTimeList(t)},a.saveChildAccessTimeHandler=function(i){if(clearValidateMsg("#childAccessTimeFrm"),!e("#childAccessTimeFrm").valid())return!1;showLoading(),s.getChildMacRuleInfo({mac_addr:a.oriChildAccessTimeList.mac_address},function(e){0==a.oriChildAccessTimeList.length?a.addNewChildAccessTimeHandler(i,e):a.updateChildAccessTimeHandler(i,e,a.oriChildAccessTimeList.mac_address)})},a.addNewChildAccessTimeHandler=function(i,t){var c=n(i.idx),d=e("#access_time_startHour_"+i.idx).val()+":"+e("#access_time_startMinute_"+i.idx).val(),r=e("#access_time_endHour_"+i.idx).val()+":"+e("#access_time_endMinute_"+i.idx).val(),_=c+"+"+d+","+r+","+i.enableStatus+";",l={child_mac_rule_info:""!=t.child_mac_rule_info?t.child_mac_rule_info+_:a.oriChildAccessTimeList.mac_address+";"+_};s.addChildAccessTimeRule(l,function(){a.fetchChildAccessTimeList({mac_addr:a.oriChildAccessTimeList.mac_address},function(){hideLoading(),successOverlay()})},function(){errorOverlay()})},a.updateChildAccessTimeHandler=function(i,t,c){var d=n(i.idx),_=r(i.idx),l=e("#access_time_startHour_"+i.idx).val()+":"+e("#access_time_startMinute_"+i.idx).val(),o=e("#access_time_endHour_"+i.idx).val()+":"+e("#access_time_endMinute_"+i.idx).val(),m=d+"+"+l+","+o+","+_,u=t.child_mac_rule_info.split(";");u[i.idx+1]=m;var h={};h.mac_addr=c,h.child_mac_rule_info=u.join(";"),";"!=h.child_mac_rule_info.slice(-1)&&(h.child_mac_rule_info=h.child_mac_rule_info+";"),s.updateChildAccessTimeRule(h,function(){a.fetchChildAccessTimeList({mac_addr:a.oriChildAccessTimeList.mac_address},function(){hideLoading(),successOverlay()})},function(){errorOverlay()})},a.addNewAccessTimeRule=function(){for(var i=0;i<e('div[name="access_time_inputDiv"]').length;i++)if(e("#"+e('div[name="access_time_inputDiv"]')[i].id).is(":visible"))return!1;if(a.oriChildAccessTimeList.length!=a.childAccessTimeList().length)return showAlert("exist_unsave_rules"),!1;if(a.childAccessTimeList().length>=o)return void showAlert({msg:"rules_max",params:o});var t=a.childAccessTimeList();a.childAccessTimeList([]);var s={idx:t.length,week:"0",weekText:"SUN",startTime:"0:00",startHour:"0",startMinute:"00",endTime:"0:01",endHour:"0",endMinute:"01",timeRange:"0:00-0:01",enableStatus:"1"};t.push(s),a.childAccessTimeList(t),e("#access_time_txt_"+s.idx).hide(),e("#access_time_inputDiv_"+s.idx).show(),e("#access_time_txtBtnDiv_"+s.idx).hide(),e("#access_time_editBtnDiv_"+s.idx).show(),e("#access_week_txt_"+s.idx).hide(),e("#access_week_edit_"+s.idx).show(),e("#pc_page2").translate(),e("#access_time_startHour_"+s.idx).rules("add",{range:[0,23],accessTimeCompare:!0}),e("#access_time_startMinute_"+s.idx).rules("add",{range:[0,59],accessTimeCompare:!0}),e("#access_time_endHour_"+s.idx).rules("add",{range:[0,23],accessTimeCompare:!0}),e("#access_time_endMinute_"+s.idx).rules("add",{range:[0,59],accessTimeCompare:!0})},a.activeChildAccessTimeHandler=function(i){if(clearValidateMsg("#childAccessTimeFrm"),!e("#childAccessTimeFrm").valid())return!1;e("#restricted_time_active_btn_"+i.idx).hasClass("active_btn_on")?(e("#restricted_time_active_btn_"+i.idx).removeClass("active_btn_on"),e("#restricted_time_active_btn_"+i.idx).addClass("active_btn_off")):(e("#restricted_time_active_btn_"+i.idx).removeClass("active_btn_off"),e("#restricted_time_active_btn_"+i.idx).addClass("active_btn_on")),a.saveChildAccessTimeHandler(i)}}function d(e,i){var t=[];if(void 0!==e&&""!=e){var s=e.split(";");t.mac_address=s[0];for(var c=1;c<s.length-1;c++){var a=s[c].split(","),d={};d.idx=c-1,d.startTime=a[0].split("+")[1],d.startHour=d.startTime.split(":")[0],d.startMinute=d.startTime.split(":")[1],d.endTime=a[1],d.endHour=d.endTime.split(":")[0],d.endMinute=d.endTime.split(":")[1],d.timeRange=a[0].split("+")[1]+"-"+a[1],d.enableStatus=a[2];var n=a[0].split("+")[0],r=["SUN","MON","TUES","WED","THUR","FRI","SAT"];d.week=[!1,!1,!1,!1,!1,!1,!1],d.weekText="";for(var _=0;_<=6;_++)-1!=n.indexOf(_)?(d.week[_]=!0,""==d.weekText?d.weekText=d.weekText+r[_]:d.weekText=d.weekText+","+r[_]):d.week[_]=!1;t.push(d)}}else t.mac_address=i;return t}function n(i){var t="";return e("#access_week_1_"+i).hasClass("wmSelectedChild")&&(t="1"),e("#access_week_2_"+i).hasClass("wmSelectedChild")&&(t+="2"),e("#access_week_3_"+i).hasClass("wmSelectedChild")&&(t+="3"),e("#access_week_4_"+i).hasClass("wmSelectedChild")&&(t+="4"),e("#access_week_5_"+i).hasClass("wmSelectedChild")&&(t+="5"),e("#access_week_6_"+i).hasClass("wmSelectedChild")&&(t+="6"),e("#access_week_0_"+i).hasClass("wmSelectedChild")&&(t+="0"),t}function r(i){return e("#restricted_time_active_btn_"+i).hasClass("active_btn_on")?"1":"0"}function _(){var t=e("#container");i.cleanNode(t[0]);var s=new a;i.applyBindings(s,t[0]),e("#pc_children_group_form").translate(),e("#childAccessTimeFrm").validate({submitHandler:function(){},rules:{},errorPlacement:function(i,t){if("access_time_startHour"==t.attr("name")||"access_time_endHour"==t.attr("name")||"access_time_startMinute"==t.attr("name")||"access_time_endMinute"==t.attr("name")){var s=t[0].id.split("_")[3];0==e("#accessTime_"+s+"_error").find("label.error").length&&i.appendTo("#accessTime_"+s+"_error")}else i.insertAfter(e("#"+t[0].id+"_error"))}}),e.validator.addMethod("accessTimeCompare",function(i,t,s){clearValidateMsg("#childAccessTimeFrm");var c=t.id.split("_")[3],a=parseInt(e("#access_time_startHour_"+c).val()),d=parseInt(e("#access_time_endHour_"+c).val()),n=parseInt(e("#access_time_startMinute_"+c).val()),r=parseInt(e("#access_time_endMinute_"+c).val());return 1!=(a>d?1:a==d&&n>r?1:0)})}var l={MAIN:0,MANAGE:1},o=10,m={getHostName:function(e,i,t){var s=c.find(t,function(e){return e.mac==i});return s?s.hostname:e}};return clickWeekHandler=function(i){var t=i.id,s=t.slice("14");e("td","#access_week_tr_"+s).each(function(){this.id==t&&e(this).hasClass("wmSelectedChild")?e(this).removeClass("wmSelectedChild"):this.id!=t||e(this).hasClass("wmSelectedChild")||e(this).addClass("wmSelectedChild")})},{init:_}});
//# sourceMappingURL=../../sourcemaps/firewall/parental_control.js.map

define(["jquery","knockout","config/config","service","underscore"],function(e,t,r,o,s){function d(){var e=this,d=a();e.portFilterEnable=t.observable(d.portFilterEnable),e.oriPortFilterEnable=t.observable(d.portFilterEnable),e.defaultPolicy=t.observable(d.defaultPolicy),e.oriDefaultPolicy=t.observable(d.defaultPolicy),e.portFilterAction=t.observable(""),e.macAddress=t.observable(""),e.destIpAddress=t.observable(""),e.sourceIpAddress=t.observable(""),e.sourceIpv6Address=t.observable(""),e.destIpv6Address=t.observable(""),e.destPortStart=t.observable(""),e.destPortEnd=t.observable(""),e.sourcePortStart=t.observable(""),e.sourcePortEnd=t.observable(""),e.modes=t.observableArray(c),e.selectedMode=t.observable("5"),e.comment=t.observable(""),e.ipv6Support=t.observable(r.IPV6_SUPPORT),e.ipType=t.observable("ipv4"),e.rules=t.observableArray(d.portFilterRules),e.policyChangeHandler=function(){var t="1"==e.defaultPolicy()?"Accept":"Drop";return e.portFilterAction(t),!0},e.gridTemplate=new t.simpleGrid.viewModel({data:e.rules(),idName:"index",columns:l,tmplType:"list",pageSize:20}),e.callback=function(t){"success"==t.result?(e.clear(),n(e),successOverlay()):errorOverlay()},e.clear=function(){e.macAddress(""),e.destIpAddress(""),e.destIpv6Address(""),e.sourceIpAddress(""),e.sourceIpv6Address(""),e.destPortStart("0"),e.destPortEnd("0"),e.sourcePortStart("0"),e.sourcePortEnd("0"),e.selectedMode("None"),e.comment(""),clearValidateMsg()},e.setPortFilterBasic=function(){showLoading();var t={};t.portFilterEnable=e.portFilterEnable(),t.defaultPolicy=e.defaultPolicy(),o.setPortFilterBasic(t,e.callback)},e.save=function(){if(e.ipv6Support()){var t="ipv4"==e.ipType()?"IPv4":"IPv6";if(s.filter(e.rules(),function(e){return e.ipType==t}).length>=r.portForwardMax)return void showAlert({msg:"rules_max_v4v6",params:[t,r.portForwardMax]});if(e.checkExist())return void showAlert({msg:"rule_exist_v4v6",params:t})}else{if(e.rules().length>=r.portForwardMax)return void showAlert({msg:"rules_max",params:r.portForwardMax});if(e.checkExist())return void showAlert("rule_exist")}showLoading();var d={};d.macAddress=e.macAddress(),e.ipv6Support()&&"ipv6"==e.ipType()?(d.destIpAddress=e.destIpv6Address(),d.sourceIpAddress=e.sourceIpv6Address()):(d.destIpAddress=e.destIpAddress(),d.sourceIpAddress=e.sourceIpAddress()),d.destPortStart=e.destPortStart(),d.destPortEnd=e.destPortEnd(),d.sourcePortStart=e.sourcePortStart(),d.sourcePortEnd=e.sourcePortEnd(),d.action=e.portFilterAction(),d.protocol=e.selectedMode(),d.comment=e.comment(),d.ipType=e.ipType(),o.setPortFilter(d,e.callback)},e.checkExist=function(){e.macAddress(e.macAddress().toUpperCase());for(var t,r=e.ipType().toUpperCase(),o={macAddress:e.macAddress(),destIpAddress:"IPV4"==r?e.destIpAddress():e.destIpv6Address(),sourceIpAddress:"IPV4"==r?e.sourceIpAddress():e.sourceIpv6Address(),destPortRange:"0"==e.destPortStart()?"":e.destPortStart()+" - "+e.destPortEnd(),sourcePortRange:"0"==e.sourcePortStart()?"":e.sourcePortStart()+" - "+e.sourcePortEnd(),action:"Drop"==e.portFilterAction()?"filter_drop":"filter_accept",protocol:transProtocolValue(e.selectedMode()),comment:e.comment(),ipType:r},d=e.rules(),a=0;a<d.length;a++)if(t={macAddress:d[a].macAddress,destIpAddress:d[a].destIpAddress,sourceIpAddress:d[a].sourceIpAddress,destPortRange:d[a].destPortRange,sourcePortRange:d[a].sourcePortRange,action:d[a].action,protocol:d[a].protocol,comment:d[a].comment,ipType:d[a].ipType.toUpperCase()},s.isEqual(o,t))return!0;return!1},e.deleteFilterRules=function(){var t=e.gridTemplate.selectedIds();if(0==t.length)return void showAlert("no_data_selected");showConfirm("confirm_data_delete",function(){showLoading("deleting");var r={};r.indexs=t,o.deleteFilterRules(r,e.callback)})},e.protocolChangeHandler=function(){return e.selectedMode()==i.ICMP||e.selectedMode()==i.NONE?(e.destPortStart("0"),e.destPortEnd("0"),e.sourcePortStart("0"),e.sourcePortEnd("0"),clearValidateMsg("#portRangeArea")):(e.destPortStart("1"),e.destPortEnd("65535"),e.sourcePortStart("1"),e.sourcePortEnd("65535")),!0},e.ipTypeChangeHandler=function(){return clearValidateMsg(),!0},e.policyChangeHandler()}function a(){return o.getPortFilter()}function n(r){var o;if(r){o=r;var s=a();return o.portFilterEnable(s.portFilterEnable),o.oriPortFilterEnable(s.portFilterEnable),o.defaultPolicy(s.defaultPolicy),o.oriDefaultPolicy(s.defaultPolicy),o.rules(s.portFilterRules),o.gridTemplate.clearAllChecked(),o.gridTemplate.data(s.portFilterRules),refreshTableHeight(),renderCheckbox(),void e(".notes-content").translate()}o=new d;var n=e("#container");t.cleanNode(n[0]),t.applyBindings(o,n[0]),fixTableHeight(),e("#filterBasicForm").validate({submitHandler:function(){o.setPortFilterBasic()}}),e("#portFilterListForm").validate({submitHandler:function(){o.deleteFilterRules()}}),e("#portFilterForm").validate({submitHandler:function(){o.save()},rules:{txtMacAddress:{filter_optional:!0,mac_check:!0},txtDestIpAddress:{ip_check:!0},txtSourceIpAddress:{ip_check:!0},txtSourceIpv6Address:{ipv6:!0},txtDestIpv6Address:{ipv6:!0},txtDestPortStart:{digits:!0,range:[1,65535],portCompare:"#txtDestPortEnd"},txtDestPortEnd:{digits:!0,range:[1,65535],portCompare:"#txtDestPortStart"},txtSourcePortStart:{digits:!0,range:[1,65535],portCompare:"#txtSourcePortEnd"},txtSourcePortEnd:{digits:!0,range:[1,65535],portCompare:"#txtSourcePortStart"},txtComment:{comment_check:!0}},groups:{destPort:"txtDestPortStart txtDestPortEnd",sourcePort:"txtSourcePortStart txtSourcePortEnd"},errorPlacement:function(e,t){"txtMacAddress"==t.attr("name")?e.appendTo("#macErrorDiv"):"txtDestPortStart"==t.attr("name")||"txtDestPortEnd"==t.attr("name")?e.appendTo("#destPortErrorDiv"):"txtSourcePortStart"==t.attr("name")||"txtSourcePortEnd"==t.attr("name")?e.appendTo("#sourcePortErrorDiv"):e.insertAfter(t)}})}var i={ICMP:"ICMP",NONE:"None"},c=s.map(r.FILTER_PROTOCOL_MODES,function(e){return new Option(e.name,e.value)}),l=[{columnType:"checkbox",rowText:"index",width:"4%"},{headerTextTrans:"mac_address",rowText:"macAddress",width:"12%"},{headerTextTrans:"ip_type",rowText:"ipType",width:"5%",display:r.IPV6_SUPPORT},{headerTextTrans:"source_ip_address",rowText:"sourceIpAddress",width:"12%"},{headerTextTrans:"dest_ip_address",rowText:"destIpAddress",width:"12%"},{headerTextTrans:"protocol",rowText:"protocol",width:"12%",needTrans:!0},{headerTextTrans:"source_port_range",rowText:"sourcePortRange",width:"12%"},{headerTextTrans:"dest_port_range",rowText:"destPortRange",width:"12%"},{headerTextTrans:"port_filter_action",rowText:"action",width:"12%",needTrans:!0},{headerTextTrans:"comment",rowText:"comment",width:"12%"}];return e.validator.addMethod("filter_optional",function(t,r,o){var d=s.any(["#txtMacAddress","#txtDestIpAddress","#txtSourceIpAddress","#txtSourceIpv6Address","#txtDestIpv6Address"],function(t){return e(t+":visible").length>0&&""!=e(t).val()}),a=s.any(["#txtDestPortStart","#txtDestPortEnd","#txtSourcePortStart","#txtSourcePortEnd"],function(t){return"0"!=e(t).val()});return d||a}),{init:n}});
//# sourceMappingURL=../../sourcemaps/firewall/port_filter.js.map

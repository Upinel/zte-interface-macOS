define(["jquery","knockout","service","config/config","status/statusBar","echarts","echarts/chart/pie"],function(e,t,a,i,r,n){function l(){return a.getTrafficAlertInfo()}function s(){f=!1,T=!1;var n=this;if(n.isCPE="CPE"==i.PRODUCT_TYPE,n.isCPE){var l=a.getOpMode();n.cpeMode=l.opms_wan_mode}n.units=t.observableArray(h);var s=v.fetchTrafficAlertInfo();n.dataLimitChecked=t.observable("0"==s.dataLimitChecked?"0":"1"),n.oriDataLimitChecked=t.observable("0"==s.dataLimitChecked?"0":"1"),n.trafficClearChecked=t.observable("on"==s.autoClearTraffic?"on":"off"),n.dataLimitTypeChecked=t.observable("0"==s.dataLimitTypeChecked?"0":"1");var c=s.limitDataMonth.split("_");"1"==c[1]?c[0]=1024*c[0]*1024:"1024"==c[1]?c[0]=1024*c[0]*1024*1024:c[0]=1024*c[0]*1024*1024*1024;var m=transUnit(parseInt(c[0],10),!1),p=getDataInfo(m),b=p.data,U=p.unit;n.limitDataMonth=t.observable(roundToTwoDecimalNumber(b)||0),"GB"==U?(n.selectedDataUnit=t.observable("1024"),n.limitDataMonth(b)):"TB"==U?(n.selectedDataUnit=t.observable("1048576"),n.limitDataMonth(b)):(n.selectedDataUnit=t.observable("1"),n.limitDataMonth(b)),n.clearDate=t.observable(s.traffic_clear_date),n.alertDataReach=t.observable(s.alertDataReach||0),n.limitTimeMonth=t.observable(s.limitTimeMonth||0),n.alertTimeReach=t.observable(s.alertTimeReach||0),n.usedDataText=t.observable(transUnit(parseInt(s.monthlySent,10)+parseInt(s.monthlyReceived,10),!1));var g=v.getDataInfo(n.usedDataText()),_=g.data,E=g.unit;n.dataUsed=t.observable(fixLength(_,5)),"GB"==E?n.selectedDataUsedUnit=t.observable("1024"):"TB"==E?n.selectedDataUsedUnit=t.observable("1048576"):"0"==_&&"B"==E?n.selectedDataUsedUnit=t.observable("1024"):"KB"==E?(_=fixLength(roundToTwoDecimalNumber(parseFloat(_/1024)),5),n.dataUsed(_),n.selectedDataUsedUnit=t.observable("1")):"B"==E?(_=fixLength(roundToTwoDecimalNumber(parseFloat(_/1048576)),5),n.dataUsed(_),n.selectedDataUsedUnit=t.observable("1")):n.selectedDataUsedUnit=t.observable("1"),n.selectedDataUsedUnit=t.observable(v.getUnitValue(E)),n.usedDataTextDescData=t.observable(""),n.usedDataTextDescData_progress=t.observable(""),n.usedDataTextDesc=t.computed(function(){return isNaN(n.dataUsed())?(n.usedDataTextDescData(""),e.i18n.prop("traffic_used_text"," ")):(n.usedDataTextDescData(n.dataUsed()+v.getUnit(n.selectedDataUsedUnit())),e.i18n.prop("traffic_used_text",n.dataUsed()+v.getUnit(n.selectedDataUsedUnit())))}),n.limitDataMonthDescData=t.observable(""),n.limitDataMonthDescData_progress=t.observable(""),n.limitDataMonthDesc=t.computed(function(){return isNaN(n.limitDataMonth())?(n.limitDataMonthDescData(""),e.i18n.prop("traffic_limit_data_text"," ")):(n.limitDataMonthDescData(n.limitDataMonth()+v.getUnit(n.selectedDataUnit())),e.i18n.prop("traffic_limit_data_text",n.limitDataMonth()+v.getUnit(n.selectedDataUnit())))}),n.alertDataReachDescData=t.observable(""),n.alertDataReachDesc=t.computed(function(){if(isNaN(n.limitDataMonth()*n.selectedDataUnit()*n.alertDataReach()))return n.alertDataReachDescData(""),e.i18n.prop("traffic_alert_reach_text","");var t=transUnit(n.limitDataMonth()*n.selectedDataUnit()*n.alertDataReach()*1048576/100,!1);return n.alertDataReachDescData(t),e.i18n.prop("traffic_alert_reach_text",t)}),n.usedDataText_progress=t.observable(0),n.leftDataDescData=t.observable(""),n.leftDataDesc=t.computed(function(){var t=1048576*(n.limitDataMonth()*n.selectedDataUnit()-n.usedDataText_progress());return t<0&&(t=0),isNaN(t)?(n.leftDataDescData(""),e.i18n.prop("traffic_data_left_text"," ")):(n.leftDataDescData(transUnit(t,!1)),e.i18n.prop("traffic_data_left_text",transUnit(t,!1)))}),n.monthlyConnectedTime=t.observable(transSecond2Time(s.monthlyConnectedTime)),n.usedTimeUnit=t.observable(function(){return s.monthlyConnectedTime/3600<1?"1":"60"}());var M=fixLength(roundToTwoDecimalNumber(parseFloat(s.monthlyConnectedTime/3600)),5);s.monthlyConnectedTime/3600<1&&(M=fixLength(roundToTwoDecimalNumber(parseFloat(s.monthlyConnectedTime/60)),5)),n.usedTime=t.observable(M),n.usedTimeTextDescData=t.observable(""),n.usedTimeTextDescData_progress=t.observable(""),n.usedTimeTextDesc=t.computed(function(){return n.usedTimeTextDescData(n.monthlyConnectedTime()),e.i18n.prop("traffic_used_text",n.monthlyConnectedTime())}),n.limitTimeMonthDescData=t.observable(""),n.limitTimeMonthDescData_progress=t.observable(""),n.limitTimeMonthDesc=t.computed(function(){return isNaN(n.limitTimeMonth())?(n.limitTimeMonthDescData(" "),e.i18n.prop("traffic_limit_time_text"," ")):(n.limitTimeMonthDescData(n.limitTimeMonth()),e.i18n.prop("traffic_limit_time_text",n.limitTimeMonth()))}),n.alertTimeReachDescData=t.observable(""),n.alertTimeReachDesc=t.computed(function(){if(isNaN(n.limitTimeMonth()*n.alertTimeReach()))return n.alertTimeReachDescData(""),e.i18n.prop("traffic_alert_reach_text","");var t=transSecond2Time(3600*n.limitTimeMonth()*n.alertTimeReach()/100);return n.alertTimeReachDescData(t),e.i18n.prop("traffic_alert_reach_text",t)}),n.leftTimeDescData=t.observable(""),n.leftTimeDesc=t.computed(function(){var t=3600*n.limitTimeMonth()-v.getSecondsFromTime(n.monthlyConnectedTime());return t<0&&(t=0),isNaN(t)?(n.leftTimeDescData(" "),e.i18n.prop("traffic_data_left_text"," ")):(n.leftTimeDescData(transSecond2Time(t)),e.i18n.prop("traffic_data_left_text",transSecond2Time(t)))}),n.save=function(){if(v.checkFormEditValid(n)&&"1"==n.dataLimitChecked())return!1;showLoading(),a.setTrafficAlertInfo({dataLimitChecked:n.dataLimitChecked(),wan_auto_clear_flow_data_switch:n.trafficClearChecked(),dataLimitTypeChecked:n.dataLimitTypeChecked(),limitDataMonth:n.limitDataMonth()+"_"+n.selectedDataUnit(),alertDataReach:n.alertDataReach(),limitTimeMonth:n.limitTimeMonth(),alertTimeReach:n.alertTimeReach(),traffic_clear_date:n.clearDate()},function(e){"success"==e.result?("1"==n.dataLimitTypeChecked()?n.saveUsedData():"0"==n.dataLimitTypeChecked()?n.saveUsedTime():(v.updateEcharts(n),r.setTrafficAlertPopuped(!1),successOverlay()),n.oriDataLimitChecked(n.dataLimitChecked())):errorOverlay()},function(){v.updateEcharts(n),errorOverlay()})},n.viewEditUsedData=t.observable(!1),n.editUsedDataHandler=function(){v.getEle("editUsedData").data("oldValue",n.dataUsed()),v.getEle("selectedDataUsedUnit").data("oldValue",n.selectedDataUsedUnit()),n.viewEditUsedData(!0)},n.saveUsedData=function(){var e=Math.round(n.dataUsed()*n.selectedDataUsedUnit()*1024*1024);a.trafficCalibration({way:"data",value:e},function(){v.fetchTrafficAlertInfo(),v.updateEcharts(n),successOverlay(),n.viewEditUsedData(!1),r.setTrafficAlertPopuped(!1),f=!1},function(){v.fetchTrafficAlertInfo(),v.updateEcharts(n),errorOverlay()})},n.editUsedDataSaveHandler=function(){v.getEle("dataUsed").valid()&&(f=!0,n.viewEditUsedData(!1))},n.editUsedDataCancelHandler=function(){n.dataUsed(v.getEle("editUsedData").data("oldValue")),n.selectedDataUsedUnit(v.getEle("selectedDataUsedUnit").data("oldValue")),v.getEle("editUsedDataCancel").siblings("label.error").hide(),n.viewEditUsedData(!1)},n.viewEditTotalData=t.observable(!1),n.editTotalDataHandler=function(){v.getEle("editTotalData").data("oldValue",n.limitDataMonth()),v.getEle("selectedDataUnit").data("oldValue",n.selectedDataUnit()),n.viewEditTotalData(!0)},n.editTotalDataSaveHandler=function(){v.getEle("limitDataMonth").valid()&&(n.usedDataText(transUnit(n.limitDataMonth()*n.selectedDataUnit()*1048576,!1)),n.viewEditTotalData(!1))},n.editTotalDataCancelHandler=function(){n.limitDataMonth(v.getEle("editTotalData").data("oldValue")),n.selectedDataUnit(v.getEle("selectedDataUnit").data("oldValue")),n.viewEditTotalData(!1)},n.viewEditAlertData=t.observable(!1),n.editAlertDataHandler=function(){v.getEle("editAlertData").data("oldValue",n.alertDataReach()),n.viewEditAlertData(!0)},n.editAlertDataSaveHandler=function(){v.getEle("alertDataReach").valid()&&n.viewEditAlertData(!1)},n.editAlertDataCancelHandler=function(){n.alertDataReach(v.getEle("editAlertData").data("oldValue")),n.viewEditAlertData(!1)},n.viewEditUsedTime=t.observable(!1),n.editUsedTimeHandler=function(){v.getEle("editUsedTime").data("oldValue",n.usedTime()),n.viewEditUsedTime(!0)},n.saveUsedTime=function(){var e=Math.round(n.usedTime()*n.usedTimeUnit()*60);a.trafficCalibration({way:"time",value:e},function(){v.fetchTrafficAlertInfo(),v.updateEcharts(n),successOverlay(),n.monthlyConnectedTime(transSecond2Time(n.usedTime()*n.usedTimeUnit()*60)),n.viewEditUsedTime(!1),r.setTrafficAlertPopuped(!1),T=!1},function(){v.fetchTrafficAlertInfo(),v.updateEcharts(n),errorOverlay()})},n.editUsedTimeSaveHandler=function(){v.getEle("usedTime").valid()&&(n.monthlyConnectedTime(transSecond2Time(n.usedTime()*n.usedTimeUnit()*60)),n.viewEditUsedTime(!1),T=!0)},n.editUsedTimeCancelHandler=function(){n.usedTime(v.getEle("editUsedTime").data("oldValue")),n.viewEditUsedTime(!1)},n.viewEditTotalTime=t.observable(!1),n.editTotalTimeHandler=function(){v.getEle("editTotalTime").data("oldValue",n.limitTimeMonth()),n.viewEditTotalTime(!0)},n.editTotalTimeSaveHandler=function(){v.getEle("limitTimeMonth").valid()&&n.viewEditTotalTime(!1)},n.editTotalTimeCancelHandler=function(){n.limitTimeMonth(v.getEle("editTotalTime").data("oldValue")),n.viewEditTotalTime(!1)},n.viewEditAlertTime=t.observable(!1),n.editAlertTimeHandler=function(){v.getEle("editAlertTime").data("oldValue",n.alertTimeReach()),n.viewEditAlertTime(!0)},n.editAlertTimeSaveHandler=function(){v.getEle("alertTimeReach").valid()&&n.viewEditAlertTime(!1)},n.editAlertTimeCancelHandler=function(){n.alertTimeReach(v.getEle("editAlertTime").data("oldValue")),n.viewEditAlertTime(!1)},v.updateEcharts(n),n.updateProgress=function(){if(!n.isCPE||n.isCPE&&("PPP"==n.cpeMode||"LTE_BRIDGE"==n.cpeMode||"AUTO_LTE_GATEWAY"==n.cpeMode)){var t=v.fetchTrafficAlertInfo();n.usedDataText(transUnit(parseInt(t.monthlySent,10)+parseInt(t.monthlyReceived,10),!1));var a=v.getDataInfo(n.usedDataText()),i=a.data,r=a.unit,l=i;if("GB"==r)var s="1024";else if("TB"==r)var s="1048576";else if("0"==i&&"B"==r)var s="1024";else if("KB"==r){i=fixLength(roundToTwoDecimalNumber(parseFloat(i/1024)),5),l=i;var s="1"}else if("B"==r){i=fixLength(roundToTwoDecimalNumber(parseFloat(i/1048576)),5),l=i;var s="1"}else var s="1";n.usedDataTextDescData_progress(l+v.getUnit(s)),n.usedDataText_progress(l*s);var c=t.limitDataMonth.split("_");"1"==c[1]?c[0]=1024*c[0]*1024:"1024"==c[1]?c[0]=1024*c[0]*1024*1024:c[0]=1024*c[0]*1024*1024*1024;var m=transUnit(parseInt(c[0],10),!1),f=getDataInfo(m),T=f.data,h=f.unit,p=roundToTwoDecimalNumber(T)||0;if("GB"==h){var b="1024";p=T}else if("TB"==h){var b="1048576";p=T}else{var b="1";p=T}n.limitDataMonthDescData_progress(p+v.getUnit(b)),n.usedTimeTextDescData_progress(transSecond2Time(t.monthlyConnectedTime)),n.monthlyConnectedTime(transSecond2Time(t.monthlyConnectedTime)),n.limitTimeMonthDescData_progress(t.limitTimeMonth||0);var U=0,g=0,_=0,E=t.limitTimeMonth||0;if("1"==n.dataLimitChecked())if(u.series[0].data=[],"1"==n.dataLimitTypeChecked())if(u.title.text=p+v.getUnit(b),u.series[0].data=[],0==p){var M=v.data.used;M.value=1,M.selected=!1,u.series[0].data.push(M)}else U=p*b*1048576,g=parseInt(D.monthlySent,10)+parseInt(D.monthlyReceived,10),_=U*(t.alertDataReach||0)/100;else if(u.title.text=E+e.i18n.prop("hours"),u.series[0].data=[],0==E){var M=v.data.used;M.value=1,M.selected=!1,u.series[0].data.push(M)}else U=3600*E,g=D.monthlyConnectedTime,_=U*n.alertTimeReach()/100;d(g,parseFloat(U)),o(_,parseFloat(U))}}}function d(e,t){var a;a=0==parseInt(t)?0:parseInt(100*parseInt(e)/parseInt(t)),a>100&&(a=100),a>=0&&setProgressBar_datausage(a)}function o(e,t){var a;a=0==parseInt(t)?0:parseInt(100*parseInt(e)/parseInt(t)),a>100&&(a=100),a>=0&&setProgressBar_datausage_alertLine(a)}function c(){var a=e("#container");t.cleanNode(a[0]);var i=new s;t.applyBindings(i,a[0]),addInterval(function(){i.updateProgress()},1e3),e("#trafficAlertForm").validate({submitHandler:function(){i.save()},rules:{dataUsed:{range_data_usage:[0,1e4],point_data_usage:!0},usedTime:{range_data_usage:[0,1e4],point_data_usage:!0},limitDataMonth:{range_data_usage2:[0,1e4],point_data_usage:!0},limitTimeMonth:{range_data_usage2:[0,1e4],point_data_usage:!0},alertDataReach:{digits:!0,range:[1,100]},alertTimeReach:{digits:!0,range:[1,100]}},errorPlacement:function(e,t){clearValidateMsg("#trafficAlertForm"),"limitDataMonth"==t.attr("name")?e.insertAfter("#editTotalDataDiv"):"alertDataReach"==t.attr("name")?e.insertAfter("#editAlertDataDiv"):"limitTimeMonth"==t.attr("name")?e.insertAfter("#editTotalTimeDiv"):"alertTimeReach"==t.attr("name")?e.insertAfter("#editAlertTimeDiv"):"dataUsed"==t.attr("name")?e.insertAfter("#editUsedDataDiv"):"usedTime"==t.attr("name")?e.insertAfter("#editUsedTimeDiv"):e.insertAfter(t)}})}var m=null,u={title:{text:"",x:"center",y:"center",itemGap:0,textStyle:{color:"#D8D8D8",fontFamily:"微软雅黑",fontSize:20,fontWeight:"bolder"},subtextStyle:{color:"#D8D8D8",fontFamily:"微软雅黑",fontSize:16,fontWeight:"bolder"}},animation:!1,series:[{name:"流量控制",type:"pie",radius:["65","93"],itemStyle:{normal:{label:{show:!1},labelLine:{show:!1}}},data:[],selectedOffset:3}],color:["red","red","red","red","red"]},D=null,f=!1,T=!1,h=_.map(i.TIME_UNITS,function(e){return new Option(e.name,e.value)}),v={cacheEle:{},getEle:function(t){return this.cacheEle.hasOwnProperty("id")?this.cacheEle[t]:(this.cacheEle[t]=e("#"+t),this.cacheEle[t])},getUnit:function(e){return"1024"==e?"GB":"1048576"==e?"TB":"MB"},getUnitValue:function(e){return e=e.toUpperCase(),"GB"==e?"1024":"TB"==e?"1048576":"1"},getDataInfo:function(e){return{data:/\d+(.\d+)?/.exec(e)[0],unit:/[A-Z]{1,2}/.exec(e)[0]}},getTimeHours:function(e){var t=e.split(":");return{h:parseInt(t[0],10),m:parseInt(t[1],10),s:parseInt(t[2],10)}},getSecondsFromTime:function(e){var t=this.getTimeHours(e);return 3600*t.h+60*t.m+t.s},fetchTrafficAlertInfo:function(){return D=l()},checkFormEditValid:function(t){var a="1"==t.dataLimitTypeChecked()&&(t.viewEditUsedData()||t.viewEditAlertData()||t.viewEditTotalData()),i="0"==t.dataLimitTypeChecked()&&(t.viewEditUsedTime()||t.viewEditAlertTime()||t.viewEditTotalTime());if(a||i)return e(".border-color-transition:visible").addClass("attention-focus"),addTimeout(function(){e(".border-color-transition:visible").removeClass("attention-focus")},1500),!0;var r=!1;return 1==t.dataLimitTypeChecked()?("0"==t.alertDataReach()&&(t.editAlertDataHandler(),r=!0),"0"==t.limitDataMonth()&&(t.editTotalDataHandler(),r=!0)):("0"==t.alertTimeReach()&&(t.editAlertTimeHandler(),r=!0),"0"==t.limitTimeMonth()&&(t.editTotalTimeHandler(),r=!0)),r&&(e(".border-color-transition:visible").addClass("attention-focus"),addTimeout(function(){e(".border-color-transition:visible").removeClass("attention-focus")},1500)),r},data:{start:{value:50,name:"提醒值内未使用",itemStyle:{normal:{color:"#D8D8D8"}}},alarm:{value:19.7,name:"警戒区",itemStyle:{normal:{color:"#8CC916"}}},alert:{value:1,name:"提醒值",itemStyle:{normal:{color:"#FF5500"}}},free:{value:50,name:"未使用",itemStyle:{normal:{color:"#D8D8D8"}}},left1:{value:50,name:"提醒值内未使用",itemStyle:{normal:{color:"#D8D8D8"}}},used:{value:30,name:"已使用",itemStyle:{normal:{color:"#8CC916"}}},full:{value:30,name:"流量超出",itemStyle:{normal:{color:"#DF4313"}}}},updateEcharts:function(t){var a=0,i=0,r=0,n=0,l=0,s=0;if("1"==t.dataLimitChecked())if(u.series[0].data=[],"1"==t.dataLimitTypeChecked())if(u.title.text=t.limitDataMonth()+v.getUnit(t.selectedDataUnit()),u.series[0].data=[],0==t.limitDataMonth()){var c=v.data.used;c.value=1,c.selected=!1,u.series[0].data.push(c)}else if(a=t.limitDataMonth()*t.selectedDataUnit()*1048576,i=parseInt(D.monthlySent,10)+parseInt(D.monthlyReceived,10),r=a*t.alertDataReach()/100,i>=a){var m=v.data.full;m.value=100,u.series[0].data.push(m)}else{r>i?(s=r-i,n=a-r):(l=i-r,n=a-i);var f=v.data.free;if(f.value=n,u.series[0].data.push(f),l>0){var T=v.data.alarm;T.value=l,u.series[0].data.push(T)}var h=v.data.alert;if(h.value=a/200,u.series[0].data.push(h),s>0){var p=v.data.left1;p.value=s,u.series[0].data.push(p)}var c=v.data.used;c.value=r-i>0?i:r,u.series[0].data.push(c)}else if(u.title.text=t.limitTimeMonth()+e.i18n.prop("hours"),u.series[0].data=[],0==t.limitTimeMonth()){var c=v.data.used;c.value=1,c.selected=!1,u.series[0].data.push(c)}else if(a=3600*t.limitTimeMonth(),i=D.monthlyConnectedTime,r=a*t.alertTimeReach()/100,i>=a){var b=v.data.full;b.value=100,u.series[0].data.push(b)}else{r-i>0?(s=r-i,n=a-r):(l=i-r,n=a-i);var U=v.data.free;if(U.value=n,u.series[0].data.push(U),l>0){var g=v.data.alarm;g.value=l,u.series[0].data.push(g)}var _=v.data.alert;if(_.value=a/200,u.series[0].data.push(_),s>0){var E=v.data.left1;E.value=s,u.series[0].data.push(E)}var M=v.data.used;M.value=r-i>0?i:r,u.series[0].data.push(M)}else{var c=v.data.used;c.value=1,c.selected=!1,u.series[0].data=[c],u.title.text=""}d(i,parseFloat(a)),o(r,parseFloat(a))},setEcharts:function(e){var t=v.data.start;t.value=.001,t.selected=!1;var a=[t].concat(e.series[0].data);e.series[0].data=a,m.setOption(e,!0),addTimeout(function(){m.resize()},1e3)}};return e.validator.addMethod("range_data_usage",function(e,t,a){return"."!=e.substring(e.length-1)&&"."!=e.substring(0,1)&&("0"!=e.substring(0,1)||1==e.length||1!=e.split(".").length)&&(this.optional(t)||e>=a[0]&&e<=a[1])}),e.validator.addMethod("range_data_usage2",function(e,t,a){return"."!=e.substring(e.length-1)&&"."!=e.substring(0,1)&&(this.optional(t)||e>a[0]&&e<=a[1])}),e.validator.addMethod("point_data_usage",function(e,t,a){return!(e.split(".")[1]&&e.split(".")[1].length>2)}),{init:c}});
//# sourceMappingURL=../../sourcemaps/status/traffic_alert.js.map

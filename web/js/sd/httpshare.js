define(["jquery","underscore","lib/jquery/jQuery.fileinput","config/config","service","knockout"],function(e,t,r,n,o,i){function a(e,t,r){if(0==e)return[];var n=[],o=s(e,t);n.push({pageNum:r-1,isActive:!1,isPrev:!0,isNext:!1,isDot:!1}),6==r?n.push({pageNum:1,isActive:!1,isPrev:!1,isNext:!1,isDot:!1}):r>5&&(n.push({pageNum:1,isActive:!1,isPrev:!1,isNext:!1,isDot:!1}),n.push({pageNum:0,isPrev:!1,isNext:!1,isActive:!1,isDot:!0}));var i,a=r-4>0?r-4:1,l=r+4;for(i=a;i<=l&&i<=o;i++)n.push({pageNum:i,isActive:i==r,isPrev:!1,isNext:!1,isDot:!1});return r+5==o?n.push({pageNum:o,isPrev:!1,isNext:!1,isActive:!1,isDot:!1}):r+3<=o&&i-1!=o&&(n.push({pageNum:0,isPrev:!1,isNext:!1,isActive:!1,isDot:!0}),n.push({pageNum:o,isPrev:!1,isNext:!1,isActive:!1,isDot:!1})),n.push({pageNum:parseInt(r,10)+1,isPrev:!1,isNext:!0,isActive:!1,isDot:!1}),n}function s(e,t){var r=Math.floor(e/t);return e%t!=0&&r++,r}function l(t){var r=0,n=e.map(t,function(e){var t={fileName:e.fileName,fileType:"document"==e.attribute?"folder":getFileType(e.fileName),fileSize:getDisplayVolume(e.size,!1),filePath:b+m()+"/"+e.fileName,lastUpdateTime:transUnixTime(1e3*(parseInt(e.lastUpdateTime,10)+A)),trClass:r%2==0?"even":"",readwrite:x};return r++,t});null==L&&(L=e.template("sdFileItemTmpl",e("#sdFileItemTmpl"))),e("#fileList_container").html(e.tmpl("sdFileItemTmpl",{data:n}))}function d(){var t=!1;"#httpshare_guest"==window.location.hash&&(t=!0),x=!0,w=1,v(""),b=n.SD_BASE_PATH,showLoading(),o.getSDConfiguration({},function(r){k=r,y=r.share_file,"1"==r.sd_status&&"0"==r.sd_mode?t&&"1"==r.share_status?(b=r.share_file,"0"==r.share_auth?(x=!1,e("#uploadSection, #delete_file_button, .sd_guest_hide_th","#httpshare_form").hide()):e("#uploadSection, #delete_file_button, .sd_guest_hide_th","#httpshare_form").show(),e("#go_to_login_button").removeClass("hide"),e("#sd_menu").hide(),e(".form-note").hide(),0==e(".customfile").length&&e("#fileField").customFileInput(),pagerItemClickHandler(1)):t&&"0"==r.share_status?(e(".form-body .content","#httpshare_form").hide().remove(),e(".form-title","#httpshare_form").attr("data-trans","httpshare").html(e.i18n.prop("httpshare")),e(".form-note","#httpshare_form").attr("data-trans","note_http_share_cannot_access").html(e.i18n.prop("note_http_share_cannot_access")),hideLoading()):(0==e(".customfile").length&&e("#fileField").customFileInput(),pagerItemClickHandler(1)):(e(".form-body .content","#httpshare_form").hide().remove(),e(".form-title","#httpshare_form").attr("data-trans","httpshare").html(e.i18n.prop("httpshare")),e(".form-note","#httpshare_form").attr("data-trans","note_http_share_usb_access").html(e.i18n.prop("note_http_share_usb_access")),e(".form-note","#httpshare_form").addClass("margintop10"),hideLoading())},function(){errorOverlay(),e(".form-body .content","#httpshare_form").hide().remove(),e(".form-title","#httpshare_form").attr("data-trans","httpshare").html(e.i18n.prop("httpshare")),e(".form-note","#httpshare_form").attr("data-trans","note_http_share_cannot_access").html(e.i18n.prop("note_http_share_cannot_access"))})}function c(){var e=o.getSDConfiguration();return!!t.isEqual(k,e)||(showAlert("sd_config_changed_reload",function(){g()}),!1)}function u(e,t){var r=y+"/",n=e+"/";return"1"==k.share_status&&""!=y&&"/"!=y&&-1!=r.indexOf(n)&&(showAlert(t),!0)}function h(){S=!0,e("#fileUploadIframe").load(function(){var t=e("#fileUploadIframe").contents().find("body").html().toLowerCase();e("#fileField").closest(".customfile").before('<input id="fileField" name="filename" maxlength="200" type="file" dir="ltr"/>').remove(),addTimeout(function(){e("#fileField").customFileInput()},0);var r=!1;-1!=t.indexOf("success")?successOverlay():-1!=t.indexOf("space_not_enough")?(r=!0,showAlert("sd_upload_space_not_enough")):-1!=t.indexOf("data_lost")?(r=!0,showAlert("sd_upload_data_lost")):errorOverlay(),e("#uploadBtn","#uploadSection").attr("data-trans","browse_btn").html(e.i18n.prop("browse_btn")),e(".customfile","#uploadSection").removeAttr("title"),e(".customfile span.customfile-feedback","#uploadSection").html('<span data-trans="no_file_selected">'+e.i18n.prop("no_file_selected")+"</span>").attr("class","customfile-feedback"),refreshFileList(m(),1,r)})}function f(e,t){var r="+/:*?<>\"'\\|#&`~";t&&(r="+:*?<>\"'\\|#&`~");for(var n=!1,o=!1,i=/^\.+$/,a=0;a<e.length;a++){for(var s=0;s<r.length;s++)if(e.charAt(a)==r.charAt(s)){n=!0;break}if(i.test(e)&&(o=!0),n||o)return!1}return!0}function _(){e("p.checkbox","#httpshare_form").die().live("click",function(){addTimeout(function(){p()},100)}),e(".icon-download","#httpshare_form").die().live("click",function(){return checkFilePathForDownload(e(this).attr("filelocal"))}),e(".folderTd","#httpshare_form").die().live("click",function(){return enterFolder(e(this).attr("filename"))}),e(".fileRename","#httpshare_form").die().live("click",function(){return renameBtnClickHandler(e(this).attr("filename"))}),S=!1}function p(){e("p.checkbox.checkbox_selected","#fileListSection").length>0?enableBtn(e("#delete_file_button")):disableBtn(e("#delete_file_button"))}function m(){return F}function v(e){F=e.lastIndexOf("/")==e.length-1?e.substring(0,e.length-1):e}function g(){var t=e("#container")[0];i.cleanNode(t);var r=new d;i.applyBindings(r,t),_()}var w=1,F="",b=n.SD_BASE_PATH,x=!0,L=null,N=null,k=null,A=60*(new Date).getTimezoneOffset(),y="";pagerItemClickHandler=function(e){w=e,refreshFileList(m(),w)},enterFolder=function(e){if(!c())return!1;var t;return t=""==e?"":m()+"/"+e,refreshFileList(t,1),!0},backFolder=function(){if(!c())return!1;var e=m().substring(0,m().lastIndexOf("/"));return refreshFileList(e,1),!0},refreshFileList=function(t,r,n){n||showLoading(),o.getFileList({path:""+b+t,index:r},function(o){if(isErrorObject(o))return void showAlert(o.errorType);v(t),e("#sd_path").val(t),w=r,totalSize=o.totalRecord,l(o.details),pagination(totalSize),refreshBtnsStatus(),updateSdMemorySizes(),n||hideLoading()})},refreshBtnsStatus=function(){""==m()?e("#rootBtnLi, #backBtnLi").hide():e("#rootBtnLi, #backBtnLi").show(),x?(e("#createNewFolderLi").hide(),e("#newFolderBtnLi").show(),e("#newFolderName").val(""),e("#createNewFolderErrorLabel").removeAttr("data-trans").text("")):e("#newFolderBtnLi, #createNewFolderLi").hide().remove(),p()},openCreateNewFolderClickHandler=function(){e("#newFolderBtnLi").hide(),e("#createNewFolderLi").show()},cancelCreateNewFolderClickHandler=function(){e("#createNewFolderLi").hide(),e("#newFolderName").val(""),e("#newFolderBtnLi").show()},createNewFolderClickHandler=function(){if(!c())return!1;var t=e.trim(e("#newFolderName").val());if(""==t)return e("#createNewFolderErrorLabel").attr("data-trans","sd_card_folder_name_is_null").text(e.i18n.prop("sd_card_folder_name_is_null")),e("#newFolderName").focus(),!1;var r=""+b+m()+"/"+t;return r.length>=200?(e("#createNewFolderErrorLabel").attr("data-trans","sd_card_path_too_long").text(e.i18n.prop("sd_card_path_too_long")),e("#newFolderName").focus(),!1):f(t,!1)?(showLoading("creating"),o.checkFileExists({path:r},function(t){"noexist"==t.status?o.createFolder({path:r},function(e){if(isErrorObject(e))return showAlert(e.errorType),!1;successOverlay(),refreshFileList(m(),1)}):"no_sdcard"==t.status?showAlert("no_sdcard",function(){window.location.reload()}):"exist"==t.status&&(e("#createNewFolderErrorLabel").attr("data-trans","sd_card_share_setting_exist").text(e.i18n.prop("sd_card_share_setting_exist")),hideLoading())},function(){errorOverlay()}),!0):(e("#createNewFolderErrorLabel").attr("data-trans","check_file_path").text(e.i18n.prop("check_file_path")),e("#newFolderName").focus(),!1)},renameBtnClickHandler=function(t){if(u(""+b+m()+"/"+t,"sd_share_path_cant_rename"))return!1;showPrompt("sd_card_folder_name_is_null",function(){if(!c())return!1;var r=e("div#confirm div.promptDiv input#promptInput"),n=e.trim(r.val()),i=""+b+m()+"/"+n;return""==n?(e(".promptErrorLabel").text(e.i18n.prop("sd_card_folder_name_is_null")),r.focus(),!1):i.length>=200?(e(".promptErrorLabel").text(e.i18n.prop("sd_card_path_too_long")),r.focus(),!1):f(n,!1)?(o.checkFileExists({path:i},function(r){if("noexist"==r.status){hideLoadingButtons();var n=""+b+m()+"/"+t;o.fileRename({oldPath:n,newPath:i,path:""+b+m()},function(e){return isErrorObject(e)?showAlert(e.errorType):(refreshFileList(m(),1),successOverlay()),showLoadingButtons(),!0})}else{if("no_sdcard"==r.status)return showAlert("no_sdcard",function(){window.location.reload()}),!1;if("exist"==r.status)return e(".promptErrorLabel").text(e.i18n.prop("sd_card_share_setting_exist")),!1}return!0},function(){errorOverlay()}),!1):(e(".promptErrorLabel").text(e.i18n.prop("check_file_path")),r.focus(),!1)},160,t)},hideLoadingButtons=function(){e(".buttons","#confirm").hide()},showLoadingButtons=function(){e(".buttons","#confirm").show()},deleteBtnClickHandler=function(){if(!c())return!1;var t=e("input:checkbox:checked","#fileList_container"),r="";if(!t||0==t.length)return!1;var n=!1;return e.each(t,function(t,r){var o=e(r).val();return!u(""+b+m()+"/"+o,{msg:"sd_share_path_cant_delete",params:[o]})||(n=!0,!1)}),!n&&(showConfirm("confirm_data_delete",function(){e.each(t,function(t,n){r+=e(n).val()+"*"});var n=""+b+m();o.deleteFilesAndFolders({path:n,names:r},function(e){if(isErrorObject(e))return void showAlert(e.errorType);successOverlay(),refreshFileList(m(),1)},function(){errorOverlay()})}),!0)},fileUploadSubmitClickHandler=function(){if(!c())return!1;var t=e(".customfile").attr("title");if(void 0===t||""==t||t==e.i18n.prop("no_file_selected"))return showAlert("sd_no_file_selected"),!1;var r=(b+m()+"/"+t).replace("//","/");return r.length>=200?(showAlert("sd_card_path_too_long"),!1):(showLoading("uploading",'<span data-trans="note_uploading_not_refresh">'+e.i18n.prop("note_uploading_not_refresh")+"</span>"),o.checkFileExists({path:r},function(r){if("noexist"==r.status){e("#fileUploadForm").attr("action","/cgi-bin/"+t);var n=(new Date).getTime();e("#path_SD_CARD_time").val(transUnixTime(n)),e("#path_SD_CARD_time_unix").val(Math.round((n-1e3*A)/1e3)),S||h(),e("#fileUploadForm").submit()}else"no_sdcard"==r.status?showAlert("no_sdcard",function(){window.location.reload()}):"exist"==r.status&&showAlert("sd_card_share_setting_exist")},function(){errorOverlay()}),!0)};var S=!1;return updateSdMemorySizes=function(){o.getSdMemorySizes({},function(t){if(isErrorObject(t))return showAlert(t.errorType),!1;var r=getDisplayVolume(t.totalMemorySize,!1),n=getDisplayVolume(t.totalMemorySize-t.availableMemorySize,!1);return e("#sd_volumn_used").text(n),e("#sd_volumn_total").text(r),!0})},pagination=function(t){var r=a(t,10,parseInt(w,10));null==N&&(N=e.template("pagerTmpl",e("#pagerTmpl"))),e(".pager","#fileListButtonSection").html(e.tmpl("pagerTmpl",{data:{pagers:r,total:s(t,10)}})),renderCheckbox(),e(".content","#httpshare_form").translate()},checkFilePathForDownload=function(e){if(!c())return!1;var t=e.lastIndexOf("/"),r=e.substring(0,t+1),n=e.substring(t+1,e.length);return!(!f(r,!0)||!f(n,!1))||(showAlert("sd_card_invalid_chars_cant_download"),!1)},gotoLogin=function(){window.location.href="#login"},{init:g}});
//# sourceMappingURL=../../sourcemaps/sd/httpshare.js.map

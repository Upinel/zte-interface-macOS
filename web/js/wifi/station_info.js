define(["underscore","jquery","knockout","config/config","service","config/menu"],function(e,t,i,a,s,c){function r(){function r(e,i){var a=t.extend({},e);s.setMacFilterStatus(a,function(e){"success"==e.result?o.checkWifiStatus():errorOverlay()})}var o=this,L={user_ip:"",WhiteMacList:"",BlackMacList:"",WhiteNameList:"",BlackNameList:""};o.showCableDiv=-1!=a.DEVICE.toLowerCase().indexOf("cpe"),o.supportBlock=a.STATION_BLOCK_SUPPORT;var v=c.findMenu("#parental_control");o.showPCLink=v&&v.length>0,o.deviceInfo=i.observableArray([]),o.cableDeviceInfo=i.observableArray([]),o.blackDevices=i.observableArray([]),o.blackDevicesMac=i.computed(function(){return e.map(o.blackDevices(),function(e){return e.macAddress})});var w=s.getUserIPAddr();L.user_ip=w.user_ip_addr,h=s.getHostNameList({}).devices;var k=s.getMacFilterStatus();o.macFilterEnable=i.observable(k.aclMode),o.macFilterEnableOri=i.observable(k.aclMode),o.blackList=i.observable(l(k.wifiHostnameBlackList,k.wifiMacBlackList)),o.whiteList=i.observable(l(k.wifiHostnameWhiteList,k.wifiMacWhiteList)),o.blackListOri=i.observable(k.wifiMacBlackList),o.whiteListOri=i.observable(k.wifiMacWhiteList),o.blackListHostNameOri=i.observable(k.wifiHostnameBlackList),o.whiteListHostNameOri=i.observable(k.wifiHostnameWhiteList),o.setMacFilterSwitch=function(){var e=n();if("1"==e.WpsStatus_1||"1"==e.WpsStatus_2)return showAlert("wps_on_info"),!1;for(var i="",a="",c=o.whiteListOri().split(";"),l=0;l<o.deviceInfo().length;l++)-1==t.inArray(o.deviceInfo()[l].macAddress,c)&&(i=o.deviceInfo()[l].macAddress+";"+i,a=o.deviceInfo()[l].hostName+";"+a);if("1"!=o.macFilterEnable())var d={aclMode:o.macFilterEnable(),wifiMacBlackList:o.blackListOri(),wifiHostnameBlackList:o.blackListHostNameOri(),wifiMacWhiteList:o.whiteListOri(),wifiHostnameWhiteList:o.whiteListHostNameOri()};else var d={aclMode:o.macFilterEnable(),wifiMacBlackList:o.blackListOri(),wifiHostnameBlackList:o.blackListHostNameOri(),wifiMacWhiteList:""==i?o.whiteListOri():i+o.whiteListOri(),wifiHostnameWhiteList:""==a?o.whiteListHostNameOri():a+o.whiteListHostNameOri()};1==s.getAntiVioCraSetting().prevent_attack_enable&&2!=o.macFilterEnable()?showConfirm("anti_vio_ack_open_note",function(){r(d)}):r(d)},o.checkWifiStatus=function(){function e(){var i=s.getWifiModuleSwitchStatus();"0"!=i.WiFiModuleSwitch&&"1"!=i.WiFiModuleSwitch?addTimeout(e,1e3):setTimeout(function(){successOverlay(),f&&setTimeout(function(){window.location.reload()},1e3),clearTimer(),clearValidateMsg(),d(o),o.clear(),t("#black_div").translate(),t("#white_div").translate(),t("#wireless_div").translate()},f?15e3:0)}setTimeout(function(){e()},2e3)},o.fetchAttachedDevices=function(i){s.getCurrentlyAttachedDevicesInfo({},function(a){if(b)return!1;o.deviceInfo(e.map(a.attachedDevices,function(t,i){return t.idx=e.uniqueId("wireless_"),t.hostName=m.getHostName(t.hostName,t.macAddress,h),t.inBlackGroup=e.contains(o.blackDevicesMac(),t.macAddress),t.type=1,t})),e.isFunction(i)&&i.apply(this),t("#wireless_div").translate()})},o.fetchAttachedCableDevices=function(i){s.getAttachedCableDevices({},function(a){if(b)return!1;o.cableDeviceInfo(e.map(a.attachedDevices,function(t,i){return t.idx=e.uniqueId("cable_"),t.hostName=m.getHostName(t.hostName,t.macAddress,h),t.type=2,t})),e.isFunction(i)&&i.apply(this),t("#cable_div").translate()})},o.fetchBlacklist=function(i){s.getDeviceAccessControlList({},function(a){L.WhiteMacList=a.WhiteMacList,L.BlackMacList=a.BlackMacList,L.WhiteNameList=a.WhiteNameList,L.BlackNameList=a.BlackNameList;var c=m.parseBlackString(a.BlackMacList,a.BlackNameList);o.blackDevices(e.map(c,function(t,i){return t.idx=e.uniqueId("black_"),t.hostName=m.getHostName(t.hostName,t.macAddress,h),t.type=3,t.isNew=!1,t}));var r=s.getMacFilterStatus();o.whiteList(l(r.wifiHostnameWhiteList,r.wifiMacWhiteList)),e.isFunction(i)&&i.apply(this),t("#black_div").translate(),t("#white_div").translate()},t.noop)},o.fetchBlacklist(),o.fetchAttachedDevices(),o.showCableDiv&&o.fetchAttachedCableDevices();var b=0;addInterval(function(){0==b&&o.fetchAttachedDevices()},3e3),o.showCableDiv&&addInterval(function(){0==b&&o.fetchAttachedCableDevices()},5e3),o.wirelessBlockHandler=function(e){if(e.ipAddress==L.user_ip)return showAlert("black_yourself_tip"),!1;if(32==L.BlackMacList.split(";").length)return showAlert("black_list_max"),!1;if(b)return showAlert("pc_not_save"),!1;if(-1!=L.BlackMacList.indexOf(e.macAddress))return!1;showLoading();var t=""==L.BlackNameList?e.hostName+";":L.BlackNameList+e.hostName+";",i=""==L.BlackMacList?e.macAddress+";":L.BlackMacList+e.macAddress+";",a={AclMode:"2",WhiteMacList:L.WhiteMacList,WhiteNameList:L.WhiteNameList,BlackNameList:t,BlackMacList:i};o.updateMacFilterList(a)},o.editHostNameHandler=function(e){return b++,t("#hostname_input_"+e.idx).val(e.hostName),m.dealElement(!0,e.idx),!1},o.saveHostNameHandler=function(e){var i=t("#hostname_input_"+e.idx),a=i.val();if(""==a){t(".promptErrorLabel","#confirm-message-container").text(t.i18n.prop("required"));var c=i.closest("td").addClass("has-error");return addTimeout(function(){c.removeClass("has-error")},5e3),showAlert("required"),!1}if(0==a.indexOf(" ")||a.lastIndexOf(" ")==a.length-1||/[\+;"\\]{1,32}/.test(a))return showAlert("device_rename"),!1;showLoading(),e.hostName=a,s.editHostName({hostname:e.hostName,mac:e.macAddress},function(){b=0,s.getHostNameList({},function(t){h=t.devices,1==e.type?o.fetchAttachedDevices(function(){hideLoading()}):2==e.type?o.fetchAttachedCableDevices(function(){hideLoading()}):3==e.type&&o.fetchBlacklist(function(){hideLoading()})})},function(){errorOverlay()})},o.cancelEditHostNameHandler=function(e){m.dealElement(!1,e.idx),b--},o.blacklistRemoveHandler=function(e){if(-1==L.BlackMacList.indexOf(e.macAddress))return!1;if(b)return showAlert("pc_not_save"),!1;showLoading();var i=[],a=[];t.each(o.blackDevices(),function(t,s){s.macAddress!=e.macAddress&&(i.push(s.macAddress),a.push(s.hostName))});var s=""==a?"":a.join(";")+";",c=""==i?"":i.join(";")+";",r={AclMode:"2",WhiteMacList:L.WhiteMacList,WhiteNameList:L.WhiteNameList,BlackNameList:s,BlackMacList:c};o.updateMacFilterList(r)},o.updateMacFilterList=function(e){s.setDeviceAccessControlList(e,function(e){"success"==e.result&&(o.blackDevices([]),o.fetchBlacklist(function(){o.fetchAttachedDevices(function(){successOverlay(),d(o)})}))},function(){errorOverlay()})},o.removeFromWhiteList=function(e){if(s.getCurretnMAC()==e.macAddress)return showAlert("white_yourself_tip"),!1;var i=e.macAddress;showLoading();var a={};a.aclMode=o.macFilterEnable(),a.wifiMacBlackList=o.blackListOri(),a.wifiHostnameBlackList=o.blackListHostNameOri();for(var c=o.whiteListOri().split(";"),r=o.whiteListHostNameOri().split(";"),n="",l="",h=0;h<c.length-1;h++)i!=c[h]&&(n+=c[h]+";",l+=r[h]+";");a.wifiMacWhiteList=n,a.wifiHostnameWhiteList=l,s.setMacFilterStatus(a,function(e){hideLoading(),"success"==e.result?(successOverlay(),d(o),o.clear(),t("#white_div").translate()):errorOverlay()})},o.addBlackMac=function(){for(var i=0;i<o.blackDevices().length;i++)if(1==o.blackDevices()[i].isNew)return!1;if(o.blackDevices().length>=u)return void showAlert({msg:"rules_max",params:u});var a=o.blackDevices();o.blackDevices([]);var s={hostName:"",idx:e.uniqueId("black_"),macAddress:"",type:3,isNew:!0};a.push(s),o.blackDevices(a),t("#black_div").translate(),t("#texNewMacAddressBlackList").rules("add",{mac_check:!0})},o.saveNewBlackList=function(){if(t("#blackListFrm").valid()){if(t("#blackListFrm").submit(),""!=o.blackListOri())for(var e=o.blackListOri().split(";"),i=0;i<e.length;i++)if(t("#texNewMacAddressBlackList").val().toLowerCase()==e[i].toLowerCase())return showAlert("rule_exist"),!1;o.addToBlackListAct(t("#texNewMacAddressBlackList").val(),"","")}},o.addToBlackListAct=function(e,t,i){var a=""==o.blackListOri()?e+";":e+";"+o.blackListOri(),s=""==o.blackListHostNameOri()?i+";":i+";"+o.blackListHostNameOri(),c={AclMode:o.macFilterEnable(),BlackMacList:a,BlackNameList:s,WhiteMacList:o.whiteListOri(),WhiteNameList:o.whiteListHostNameOri()};o.updateMacFilterList(c)},o.addWhiteMac=function(){for(var e=0;e<o.whiteList().length;e++)if(1==o.whiteList()[e].isNew)return!1;if(o.whiteList().length>=u)return void showAlert({msg:"rules_max",params:u});var i=o.whiteList();o.whiteList([]);var a={hostName:"",macAddress:"",isNew:!0};i.push(a),o.whiteList(i),t("#white_div").translate(),t("#texNewMacAddressWhiteList").rules("add",{mac_check:!0})},o.saveNewWhiteList=function(){if(t("#whiteListFrm").valid()){if(t("#whiteListFrm").submit(),""!=o.whiteListOri())for(var e=o.whiteListOri().split(";"),i=0;i<e.length;i++)if(t("#texNewMacAddressWhiteList").val().toLowerCase()==e[i].toLowerCase())return showAlert("rule_exist"),!1;o.addToWhiteListAct(t("#texNewMacAddressWhiteList").val(),"","")}},o.addToWhiteListAct=function(e,t,i){var a=""==o.whiteListOri()?e+";":e+";"+o.whiteListOri(),s=""==o.whiteListHostNameOri()?i+";":i+";"+o.whiteListHostNameOri(),c={AclMode:o.macFilterEnable(),BlackMacList:o.blackListOri(),BlackNameList:o.blackListHostNameOri(),WhiteMacList:a,WhiteNameList:s};o.updateMacFilterList(c)},o.discard=function(){o.blackDevices([]),o.fetchBlacklist(function(){o.fetchAttachedDevices(function(){d(o)})})},o.clear=function(){}}function n(){var e=s.getWifiWpsStatus();return wifiWPSActiveInfo(e)}function l(e,t){if(""==t)return[];for(var i=e.split(";"),a=t.split(";"),s=[],c=0;c<a.length-1;c++){var r={};r.hostName=o(i[c],a[c],h),r.macAddress=a[c],r.index=c,r.isNew=!1,s.push(r)}return s}function o(t,i,a){var s=e.find(a,function(e){return e.mac==i});return s?s.hostname:t}function d(e){if(e){n=e;var a=s.getMacFilterStatus();return n.info=a,n.macFilterEnable(a.aclMode),n.macFilterEnableOri(a.aclMode),n.blackList(l(a.wifiHostnameBlackList,a.wifiMacBlackList)),n.whiteList(l(a.wifiHostnameWhiteList,a.wifiMacWhiteList)),n.blackListOri(a.wifiMacBlackList),n.whiteListOri(a.wifiMacWhiteList),n.blackListHostNameOri(a.wifiHostnameBlackList),n.whiteListHostNameOri(a.wifiHostnameWhiteList),t("#black_div").translate(),void t("#white_div").translate()}var c=t("#container")[0];i.cleanNode(c);var n=new r;i.applyBindings(n,c),t("#macFilterForm").validate({submitHandler:function(){n.setMacFilterSwitch()}}),t("#blackListFrm").validate({submitHandler:function(){}}),t("#whiteListFrm").validate({submitHandler:function(){}})}var h="",u=32,f=!1,m={dealElement:function(e,i){e?(t("#edit_btn_"+i+",#hostname_txt_"+i).hide(),t("#save_btn_"+i+",#cancel_btn_"+i+",#hostname_input_"+i).show()):(t("#edit_btn_"+i+",#hostname_txt_"+i).show(),t("#save_btn_"+i+",#cancel_btn_"+i+",#hostname_input_"+i).hide())},parseBlackString:function(e,t){if(""==e)return[];for(var i=t.split(";"),a=e.split(";"),s=[],c=0;c<a.length-1;c++){var r={};r.hostName=i[c],r.macAddress=a[c],s.push({hostName:i[c],macAddress:a[c]})}return s},getHostName:function(t,i,a){var s=e.find(a,function(e){return e.mac==i});return s?s.hostname:t}};return{init:d}});
//# sourceMappingURL=../../sourcemaps/wifi/station_info.js.map

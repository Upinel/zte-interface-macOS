define(["jquery","knockout","config/config","service","underscore","lib/jquery/chosen.jquery"],function(e,n,o,t,a,i){function r(){return e("#selectedFilterGroup").val()}function s(){function a(){var e=22;if(I.selectedLocation()==u.DEVICE)e=22;else{var n=getEncodeType(I.name());e="UNICODE"==n.encodeType||n.extendLen>0?I.capacity().simMaxNameLen/2-1:I.capacity().simMaxNameLen}return e}function i(){return I.selectedLocation()==u.DEVICE?40:I.capacity().simMaxNumberLen}function s(n){e("#frmPhoneBook").hide(),I.pageState(h.LIST),I.index(-1),I.name(""),I.mobile_phone_number(""),I.home_phone_number(""),I.office_phone_number(""),I.mail(""),I.messageContent(""),1==n&&C(),I.gridTemplate.clearAllChecked(),clearValidateMsg(),e("#books ").translate(),e("#frmPhoneBook").show()}function m(){var n=I.messageContent(),t=!1,a=getSelectValFromChosen(e(".search-choice","#chosenUserSelect_chzn")),i=!(a&&a.length>0);return void 0===n||""==n?(o.resetContentModifyValue(),!1):(t=!0)&&!i?(o.CONTENT_MODIFIED.modified=!0,o.CONTENT_MODIFIED.message="sms_to_save_draft",o.CONTENT_MODIFIED.callback.ok=p,o.CONTENT_MODIFIED.callback.no=e.noop,o.CONTENT_MODIFIED.data={content:n,numbers:a},!1):t&&i?(o.CONTENT_MODIFIED.modified=!0,o.CONTENT_MODIFIED.message="sms_no_recipient",o.CONTENT_MODIFIED.callback.ok=e.noop,o.CONTENT_MODIFIED.callback.no=function(){return!0},!1):void 0}function p(e){var n=new Date,o={index:-1,currentTimeString:getCurrentTimeString(n),groupId:e.numbers.length>1?n.getTime():"",message:e.content,numbers:e.numbers};t.saveSMS(o,function(){successOverlay("sms_save_draft_success")},function(){errorOverlay("sms_save_draft_failed")})}function d(n,t,a){if("sms_to_save_draft"!=o.CONTENT_MODIFIED.message){if(o.CONTENT_MODIFIED.modified)return showConfirm(o.CONTENT_MODIFIED.message,{ok:function(){o.CONTENT_MODIFIED.callback.ok(o.CONTENT_MODIFIED.data),n(t),o.resetContentModifyValue()},no:function(){return"sms_to_save_draft"==o.CONTENT_MODIFIED.message&&n(t),!!a||(o.resetContentModifyValue(),!1)}}),!1;n(t)}else{if(syncSelectAndChosen(e("select#chosenUserSelect"),e(".search-choice","#chosenUserSelect_chzn")).length+smsCapability.nvUsed>smsCapability.nvTotal)return void showAlert({msg:"sms_capacity_will_full_just_draft",params:[smsCapability.nvTotal-smsCapability.nvUsed]});o.CONTENT_MODIFIED.callback.ok(o.CONTENT_MODIFIED.data),n(t)}}function v(){t.getPhoneBookReady({},function(e){if("6"==e.pbm_init_flag)I.initFail(!0),hideLoading(),showAlert("phonebook_init_fail");else if("0"!=e.pbm_init_flag)addTimeout(v,1e3);else{I.initFail(!1);var n=l();I.capacity(n),I.phoneBookCapacity(n.Ratio);var o=c(n.Used);I.books(o),I.gridTemplate.data(o),hideLoading()}})}function C(){showLoading();var e=l();I.phoneBookCapacity(e.Ratio),I.capacity(e);var n=c(e.Used);I.books(n),I.gridTemplate.data(n),hideLoading()}function T(){I.preContent.location=I.selectedLocation(),I.preContent.name=I.name(),I.preContent.mobile_phone_number=I.mobile_phone_number(),I.preContent.home_phone_number=I.home_phone_number(),I.preContent.office_phone_number=I.office_phone_number(),I.preContent.mail=I.mail(),I.preContent.group=I.selectedGroup()}function S(){var e=I.preContent.location!=I.selectedLocation()||I.preContent.name!=I.name()||I.preContent.mobile_phone_number!=I.mobile_phone_number()||I.preContent.home_phone_number!=I.home_phone_number()||I.preContent.office_phone_number!=I.office_phone_number()||I.preContent.mail!=I.mail()||I.preContent.group!=I.selectedGroup();o.CONTENT_MODIFIED.modified=e}function y(){o.resetContentModifyValue(),T(),o.CONTENT_MODIFIED.checkChangMethod=S}var I=this;I.pageState=n.observable(h.LIST),I.initFail=n.observable(!0),I.hasSms=n.observable(o.HAS_SMS);var k={simMaxNameLen:0,simMaxNumberLen:0,IsSimCardFull:!0,IsDeviceFull:!0,Used:0,Capacity:0,Ratio:"(0/0)"};I.capacity=n.observable(k),I.phoneBookCapacity=n.observable(k.Ratio),I.books=n.observableArray(),I.gridTemplate=new n.simpleGrid.viewModel({tableClass:"table-fixed",data:I.books(),idName:"index",columns:_.listColumns,defaultSortField:"name",defaultSortDirection:"ASC",pageSize:10,tmplType:"list",searchColumns:["name","mobile_phone_number"],primaryColumn:"mobile_phone_number",showPager:!0,rowClickHandler:function(e){I.editBooks(e,"view")},deleteHandler:function(e){I.deleteOneBook(e)},changeTemplateHandler:function(){I.changeTemplate()}}),I.locations=n.observableArray(),I.originLocation="",I.selectedLocation=n.observable(u.DEVICE),I.locationTrans=n.observable(),I.locationTransText=n.observable(),I.index=n.observable(-1),I.name=n.observable(""),I.nameMaxLength=n.computed(function(){var e=a(),n=I.name().substring(0,e);return I.name(n),a()}),I.mobile_phone_number=n.observable(""),I.mobileMaxLength=n.computed(function(){var e=i(),n=I.mobile_phone_number().substring(0,e);return I.mobile_phone_number(n),i()}),I.home_phone_number=n.observable(""),I.office_phone_number=n.observable(""),I.mail=n.observable(""),I.transEditAreaTitle=n.dependentObservable(function(){var e=I.pageState();return e==h.EDIT?"edit":e==h.NEW?"new":e==h.VIEW?"view":void 0});var E=g();I.groups=n.observableArray(E),I.selectedGroup=n.observable(),I.groupTrans=n.observable(),I.groupTransText=n.observable(),I.selectedFilterGroup=n.observable("all"),I.selectedFilterGroupChangeHandler=function(){I.selectedFilterGroup(e("#selectedFilterGroup").val()),v()},I.showErrorInfo=n.observable(!1),I.messageContent=n.observable(""),I.messageCount=n.computed(function(){var n=e("#txtSmsContent","#sendMessage"),o=n[0];I.messageContent();var t=n.val(),a=getEncodeType(t),i="UNICODE"==a.encodeType?335:765;if(t.length+a.extendLen>i){for(var r=o.scrollTop,s=getInsertPos(o),c=t.length+a.extendLen-i,l=t.substr(s-c>0?s-c:0,c),p=l.split("").reverse(),d=0,u=0,h=0;h<p.length;h++)if(getEncodeType(p[h]).extendLen>0?d+=2:d++,d>=c){u=h+1;break}var b=s-u;I.messageContent(t.substr(0,b)+t.substr(s)),I.messageContent().length>i&&I.messageContent(I.messageContent().substr(0,i)),setInsertPos(o,b),o.scrollTop=r}m();var _=e(o).val(),g=getEncodeType(_),f="UNICODE"==g.encodeType?335:765;return _.length+g.extendLen>=f?e("#msgCount").addClass("colorRed"):e("#msgCount").removeClass("colorRed"),"("+(_.length+g.extendLen)+"/"+f+")("+getSmsCount(_)+"/5)"}),I.clear=function(n){if(o.CONTENT_MODIFIED.modified){var t=syncSelectAndChosen(e("select#chosenUserSelect"),e(".search-choice","#chosenUserSelect_chzn")),a=!t||0==t.length;a&&("sms_no_recipient",o.CONTENT_MODIFIED.message="sms_no_recipient")}I.pageState()==h.SEND_MSM?d(s,n,a):(s(n),o.resetContentModifyValue())},I.checkHasSIMCard=function(e){return"modem_init_complete"==t.getStatusInfo().simStatus||(e&&showAlert("sim_removed",function(){I.pageState(h.LIST),I.clear(!0)}),!1)},I.save=function(){var n=function(n){var a=o==u.SIM;if(!a||I.checkHasSIMCard(!0)){if(I.pageState()==h.NEW||o!=I.originLocation)if(a){if(I.capacity().IsSimCardFull)return void showAlert("sim_full")}else if(I.capacity().IsDeviceFull)return void showAlert("device_full");var i=I.name(),r=I.mobile_phone_number();if(""!=e.trim(i)&&""!=e.trim(r)){showLoading("saving");var s={};s.location=o,s.index=n,s.name=i,s.mobile_phone_number=r,a||(s.home_phone_number=I.home_phone_number(),s.office_phone_number=I.office_phone_number(),s.mail=I.mail(),s.group=I.selectedGroup()),t.savePhoneBook(s,I.callback)}}},o=I.selectedLocation(),a=o==I.originLocation?I.index():-1;o==u.SIM&&I.originLocation==u.DEVICE?showConfirm("change_device_to_sim_confirm",function(){n(a)}):n(a)},I.openNewPage=function(){I.pageState(h.NEW),I.selectedLocation(u.DEVICE),I.originLocation="",I.checkHasSIMCard(!1)?I.locations(b(!0)):I.locations(b(!1));var e=r();"all"!=e&&I.selectedGroup(e),I.dynamicTranslate(),y()},I.openPage=function(e){var n;if(I.pageState()==h.LIST){var o=I.checkSelect(e);if(!o.isCorrectData)return;n=o.selectedIds[0]}else n=I.index();I.editBooks(n,e)},I.openViewPage=function(){I.openPage("view")},I.openEditPage=function(){I.openPage("edit"),e.browser.mozilla&&e("#txtName, #txtMobile").removeAttr("maxlength"),y()},I.editBooks=function(n,o){if(n){I.locations(b(!0));for(var t=I.books(),a=0;a<t.length;a++){var i=t[a];if(i.index==n){I.index(i.index),I.selectedLocation(i.location),I.originLocation=i.location;var r=i.location==u.DEVICE?"device":"sim";I.locationTrans(r);var s=e.i18n.prop("trans");I.locationTransText(s),I.name(i.name),I.mobile_phone_number(i.mobile_phone_number),I.home_phone_number(i.home_phone_number),I.office_phone_number(i.office_phone_number),I.mail(i.mail),I.selectedGroup(i.group),I.groupTrans("group_"+i.group),I.groupTransText(e.i18n.prop(I.groupTrans())),"edit"==o?I.pageState(h.EDIT):I.pageState(h.VIEW);break}}I.dynamicTranslate(),I.selectedLocation()==u.SIM&&I.checkHasSIMCard(!0)}},I.dynamicTranslate=function(){e("#container").translate()},I.deleteOneBook=function(e){return showConfirm("confirm_pb_delete",function(){showLoading("deleting");var n={};n.indexs=[String(e)],t.deletePhoneBooks(n,I.callback)}),!1},I.deleteBook=function(){I.deleteOneBook(I.index())},I.deleteBooks=function(){var e=I.checkSelect("delete");e.isCorrectData&&showConfirm("confirm_pb_delete",function(){showLoading("deleting");var n={};n.indexs=e.selectedIds,t.deletePhoneBooks(n,I.callback)})},I.checkSelect=function(e){var n;n="send"==e?I.gridTemplate.selectedPrimaryValue():I.gridTemplate.selectedIds();var o=!0;return 0==n.length?(showAlert("no_data_selected"),o=!1):"edit"==e||"view"==e?n.length>1&&(showAlert("too_many_data_selected"),o=!1):"send"==e&&n.length>5&&(showAlert("max_send_number"),o=!1),{selectedIds:n,isCorrectData:o}},I.deleteAllBooks=function(){showConfirm("confirm_data_delete",function(){showLoading("deleting");var e=r(),n={};"all"==e?(n.location=2,t.deleteAllPhoneBooks(n,I.callback)):(n.location=3,n.group=e,t.deleteAllPhoneBooksByGroup(n,I.callback))})},I.callback=function(n){n&&"success"==n.result?(I.clear(!0),e("#books ").translate(),renderCheckbox(),successOverlay(null,!0)):errorOverlay()},I.changeTemplate=function(){"card"==I.gridTemplate.tmplType?(I.gridTemplate.tmplType="list",I.gridTemplate.pageSize=10,I.gridTemplate.columns=_.listColumns):(I.gridTemplate.tmplType="card",I.gridTemplate.pageSize=10,I.gridTemplate.columns=_.cardColumns),C(),e("#books ").translate()},I.openSendMessagePage=function(){e("#msgCount").html("(0/756)(1/5)");var n=null;if(h.LIST==I.pageState()){var t=I.checkSelect("send");if(!t.isCorrectData)return;n=t.selectedIds}else n=I.mobile_phone_number();var a=e("#chosenUserList .chzn-select-deselect");a.empty();for(var i=[],r=[],s=0;s<o.phonebook.length;s++){var c=o.phonebook[s];-1==e.inArray(c.pbm_number,r)&&(i.push(new Option(c.pbm_name+"/"+c.pbm_number,c.pbm_number,!1,!0)),r.push(c.pbm_number))}var l="";e.each(i,function(e,n){l+="<option value='"+n.value+"'>"+n.text+"</option>"}),a.append(l),a.chosen({max_selected_options:5,search_contains:!0,width:"545px"}),e("#chosenUserSelect").val(n),e("#chosenUserSelect").trigger("liszt:updated"),o.resetContentModifyValue(),m(),I.pageState(h.SEND_MSM)},I.sendMessage=function(){t.getSmsCapability({},function(n){return n.nvUsed<n.nvTotal?syncSelectAndChosen(e("select#chosenUserSelect"),e(".search-choice","#chosenUserSelect_chzn")).length+n.nvUsed>n.nvTotal?(showAlert({msg:"sms_capacity_will_full_just",params:[n.nvTotal-n.nvUsed]}),!1):(I.sendMessageAction(),!0):(showAlert("sms_capacity_is_full_for_send"),!1)})},I.sendMessageAction=function(){var n=syncSelectAndChosen(e("select#chosenUserSelect"),e(".search-choice","#chosenUserSelect_chzn"));if(n&&0!=n.length){var a=I.messageContent(),i=0,r=0;n.length>1?showLoading("sending","<button id='btnStopSending' onclick='phoneBookStopSMSSending();' class='btn btn-primary'>"+e.i18n.prop("sms_stop_sending")+"</button>"):showLoading("sending");var s=function(t){if(++i==n.length)if(e("#chosenUserSelect").val(""),I.messageContent(""),o.CONTENT_MODIFIED.modified=!1,0==r)successOverlay(),location.hash="#smslist";else{var a=e.i18n.prop("success_info")+e.i18n.prop("colon")+(i-r)+"<br/>"+e.i18n.prop("error_info")+e.i18n.prop("colon")+r;showAlert(a,function(){location.hash="#smslist"})}else c()};f=!1;var c=function(){if(f)return void hideLoading();i+1==n.length&&e("#loading #loading_container").html(""),t.sendSMS({number:n[i],message:a,id:-1},function(e){s()},function(e){r++,s()})};c()}else{I.showErrorInfo(!0);var l=addTimeout(function(){I.showErrorInfo(!1),window.clearTimeout(l)},5e3)}},I.clearSearchKey=function(){I.gridTemplate.searchInitStatus(!0),I.gridTemplate.searchKey(e.i18n.prop("search")),e("#ko_grid_search_txt").addClass("ko-grid-search-txt-default").attr("data-trans","search")},I.searchTextClick=function(){var n=e("#ko_grid_search_txt");n.hasClass("ko-grid-search-txt-default")&&(I.gridTemplate.searchKey(""),I.gridTemplate.searchInitStatus(!1),n.removeClass("ko-grid-search-txt-default").removeAttr("data-trans"))},I.searchTextBlur=function(){""==e.trim(I.gridTemplate.searchKey()).toLowerCase()&&I.clearSearchKey()},I.hasData=n.computed(function(){return I.gridTemplate.afterSearchData().length>0}),I.hasChecked=n.computed(function(){return I.gridTemplate.checkedCount()>0}),I.canSend=n.computed(function(){var e=I.gridTemplate.checkedCount();return!!I.checkHasSIMCard(!1)&&(e>0&&e<=5)}),I.draftListenerEvent=function(){m()},showLoading("waiting"),addTimeout(v,200),I.preContent={}}function c(e){var n={};n.page=0,n.data_per_page=e,n.orderBy="name",n.isAsc=!0;var i=[],s=r();return o.HAS_SMS?(i=t.getPhoneBooks(n),o.phonebook=i.pbm_data,"all"!=s&&(i={pbm_data:a.filter(i.pbm_data,function(e){return e.pbm_group==s})})):"all"!=s?(n.group=s,i=t.getPhoneBooksByGroup(n)):i=t.getPhoneBooks(n),m(i.pbm_data)}function l(){var e=t.getSIMPhoneBookCapacity(),n=t.getDevicePhoneBookCapacity();return{simUsed:e.simPbmUsedCapacity,deviceUsed:n.pcPbmUsedCapacity,simCapacity:e.simPbmTotalCapacity,deviceCapacity:n.pcPbmTotalCapacity,simMaxNameLen:e.maxNameLen,simMaxNumberLen:e.maxNumberLen,IsSimCardFull:e.simPbmUsedCapacity==e.simPbmTotalCapacity,IsDeviceFull:n.pcPbmUsedCapacity==n.pcPbmTotalCapacity,Used:e.simPbmUsedCapacity+n.pcPbmUsedCapacity,Capacity:e.simPbmTotalCapacity+n.pcPbmTotalCapacity,Ratio:"("+(e.simPbmUsedCapacity+n.pcPbmUsedCapacity)+"/"+(e.simPbmTotalCapacity+n.pcPbmTotalCapacity)+")"}}function m(e){var n=[],o=r(),t="all"!=o;if(e)for(var a=0;a<e.length;a++){if(t){var i=e[a].pbm_group;if(e[a].pbm_location==u.SIM||i!=o)continue}var s={index:e[a].pbm_id,location:e[a].pbm_location,imgLocation:e[a].pbm_location==u.SIM?"img/sim.png":"img/device.png",name:e[a].pbm_name,mobile_phone_number:e[a].pbm_number,home_phone_number:e[a].pbm_anr,office_phone_number:e[a].pbm_anr1,mail:e[a].pbm_email,group:e[a].pbm_group,transGroup:e[a].pbm_group?"group_"+e[a].pbm_group:"group_null"};n.push(s)}return n}function p(){t.getSmsCapability({},function(e){smsCapability=e})}function d(){var o=e("#container");n.cleanNode(o[0]);var t=new s;n.applyBindings(t,o[0]),e("#txtSmsContent").die().live("contextmenu",function(){return!1}),p(),e("#frmPhoneBook").validate({submitHandler:function(){t.save()},rules:{txtMail:"email_check",txtName:"name_check",txtMobile:"phonenumber_check",txtHomeNumber:"phonenumber_check",txtOfficeNumber:"phonenumber_check"}})}smsCapability={};var u={SIM:"0",DEVICE:"1"},h={LIST:0,NEW:1,EDIT:2,VIEW:3,SEND_MSM:4},b=function(n){var o=[];return o.push(new Option(e.i18n.prop("device_book"),u.DEVICE)),n&&o.push(new Option(e.i18n.prop("sim_book"),u.SIM)),o},_={cardColumns:[{rowText:"index",display:!1},{rowText:"name"},{rowText:"mobile_phone_number"},{rowText:"home_phone_number"}],listColumns:[{columnType:"checkbox",headerTextTrans:"number",rowText:"index",width:"10%"},{headerTextTrans:"name",rowText:"name",width:"25%",sortable:!0},{columnType:"image",headerTextTrans:"save_location",rowText:"imgLocation",width:"20%",sortable:!0},{headerTextTrans:"mobile_phone_number",rowText:"mobile_phone_number",width:"30%",sortable:!0},{headerTextTrans:"group",rowText:"transGroup",width:"15%",sortable:!0,needTrans:!0}]},g=function(){var n=[];return n.push(new Option(e.i18n.prop("common"),"common")),n.push(new Option(e.i18n.prop("family"),"family")),n.push(new Option(e.i18n.prop("friend"),"friend")),n.push(new Option(e.i18n.prop("colleague"),"colleague")),n},f=!1;return phoneBookStopSMSSending=function(){f=!0,e("#loading #loading_container").html(e.i18n.prop("sms_cancel_sending"))},{init:d}});
//# sourceMappingURL=../../sourcemaps/phonebook/phonebook.js.map

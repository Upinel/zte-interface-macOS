define(["underscore","jquery","knockout","config/config","service","lib/jquery/chosen.jquery"],function(e,t,s,n,a,o){function i(e){return a.getSMSMessages({page:0,smsCount:500,nMessageStoreType:1,tags:10,orderBy:"order by id desc"},function(s){tryToDisableCheckAll(t("#smslist-checkAll","#smsListForm"),s.messages.length),n.dbMsgs=s.messages,n.listMsgs=r(n.dbMsgs),e()},function(){tryToDisableCheckAll(t("#smslist-checkAll","#smsListForm"),0),n.dbMsgs=[],n.listMsgs=[],cleanSmsList()})}function r(s){var a={},o=[];return n.listMsgs=[],P=[],t.each(s,function(e,t){if("4"==t.tag&&""!=t.groupId)return void P.push(t);t.target=t.number,parseInt(t.id,10)>n.smsMaxId&&(n.smsMaxId=t.id);var s=getLast8Number(t.number);s in a?a[s].push(t):(a[s]=[t],o.push(t))}),o=e.sortBy(o,function(e){return 0-parseInt(e.id+"",10)}),t.each(o,function(e,t){for(var s=getLast8Number(t.number),o=0,i=!1,r=0;r<a[s].length;r++)a[s][r].isNew&&o++,"4"==a[s][r].tag&&""==a[s][r].groupId&&(i=!0);n.listMsgs.push({id:a[s][0].id,name:"",number:a[s][0].number,latestId:a[s][0].id,totalCount:a[s].length,newCount:o,latestSms:a[s][0].content,latestTime:a[s][0].time,checked:!1,itemId:getLast8Number(s),groupId:a[s][0].groupId,hasDraft:i})}),n.listMsgs}function l(){var e=a.getPhoneBooks({page:0,data_per_page:2e3,orderBy:"name",isAsc:!0});if(t.isArray(e.pbm_data)&&e.pbm_data.length>0){for(var s=0;s<e.pbm_data.length;s++)e.pbm_data[s].pbm_name=HTMLEncode(e.pbm_data[s].pbm_name);n.phonebook=e.pbm_data}m()}function m(){var e=t("#chosenUserList .chzn-select-deselect");e.empty();for(var s=[],a=[],o=[],i=0;i<n.phonebook.length;i++){var r=n.phonebook[i],l=getLast8Number(r.pbm_number);-1==t.inArray(l,o)&&""!=t.trim(l)&&(s.push(new Option(r.pbm_name+"/"+r.pbm_number,l,!1,!0)),-1==t.inArray(l,a)&&a.push(l),o.push(l))}for(var m=[],u=0;u<P.length;u++){if(-1==t.inArray(P[u].groupId,m)){m.push(P[u].groupId);var h=P[u];F[P[u].groupId]=[h]}else{var h=P[u];F[P[u].groupId].push(h)}var p=getLast8Number(P[u].number);-1==t.inArray(p,a)&&(s.push(new Option(P[u].number,p)),a.push(p))}for(var g in F){var b=F[g],f=b[b.length-1];f.draftShowName="",f.draftShowNameTitle="",t.each(b,function(e,t){var s=getShowNameByNumber(t.number);f.draftShowName+=(0==e?"":";")+s,f.draftShowNameTitle+=(0==e?"":";")+s});var v=18;"UNICODE"==getEncodeType(f.draftShowName).encodeType&&(v=10),f.draftShowName=f.draftShowName.length>v?f.draftShowName.substring(0,v)+"...":f.draftShowName,f.totalCount=b.length,f.hasDraft=!0,f.latestTime=f.time,H.push(f)}for(var C=0;C<n.listMsgs.length;C++){for(var _=n.listMsgs[C],i=0;i<n.phonebook.length;i++){var r=n.phonebook[i],l=getLast8Number(r.pbm_number);if(_.itemId==l){_.name=r.pbm_name;for(var u=0;u<s.length;u++)if(l==s[u].value){s[u].value=getLast8Number(_.number),s[u].text=r.pbm_name+"/"+_.number;break}break}}-1==t.inArray(_.itemId,a)&&(s.push(new Option(_.number,getLast8Number(_.number))),a.push(_.itemId))}var k="";t.each(s,function(e,t){k+="<option value='"+t.value+"'>"+t.text+"</option>"}),e.append(k),e.chosen({max_selected_options:5,search_contains:!0,width:"780px"}),c(),d(),B=!0}function c(){null==D&&(D=t.template("smsTableTmpl",t("#smsTableTmpl"))),t.tmpl("smsTableTmpl",{data:n.listMsgs}).translate().appendTo("#smslist-table"),n.HAS_PHONEBOOK?t(".sms-add-contact-icon").removeClass("hide"):t(".sms-add-contact-icon").addClass("hide")}function d(){if(0==H.length)return!1;null==D&&(D=t.template("smsTableTmpl",t("#smsTableTmpl"))),t.tmpl("smsTableTmpl",{data:H}).translate().prependTo("#smslist-table")}function u(e){t("select.chzn-select-deselect").val("").trigger("liszt:updated"),n.currentChatObject=null,t(".smslist-btns","#smslist-main").removeClass("smsListFloatButs"),e&&"smsIcon"==e?window.location.hash="#home":h("list")}function h(e){"chat"==e?(t("#smslist-main").hide(),t("#smsChatRoom").show(),t("#sms_nav_home").hide(),t("#sms_nav_back").show()):(t("#smsChatRoom").hide(),t("#smslist-main").show(),t("#sms_nav_back").hide(),t("#sms_nav_home").show())}function p(e){if(0==n.dbMsgs.length)n.dbMsgs=[e];else for(var s=0;s<n.dbMsgs.length;s++){if(n.dbMsgs[s].id==e.id)return void(n.dbMsgs[s]=e);var a=[e];return t.merge(a,n.dbMsgs),void(n.dbMsgs=a)}}function g(e,s,a){if(e&&e.number||s){var o="";o=e&&void 0!==e.groupId&&""!=e.groupId?e.groupId:getLast8Number(s||e.number);var i=t("#smslist-item-"+o);if(i&&i.length>0){var r=i.find(".smslist-item-total-count"),l=r.text();if(l=Number(l.substring(1,l.length-1)),s){if(1==l||null==e)return void i.hide().remove();r.text("("+(l-(a||1))+")"),i.find(".smslist-item-draft-flag").addClass("hide")}else r.text("("+(l+1)+")"),"4"==e.tag&&i.find(".smslist-item-draft-flag").removeClass("hide");i.find(".smslist-item-checkbox p.checkbox").attr("id",e.id),i.find(".smslist-item-checkbox input:checkbox").val(e.id).attr("id","checkbox"+e.id);var m=HTMLEncode(e.content);"4"==e.tag&&(m='<span class="smslist-item-draft-flag colorRed" data-trans="draft"></span>: '+m);i.find(".smslist-item-msg").html(m).closest("td").prop("title",e.content),i.find(".smslist-item-repeat span").die().click(function(){forwardClickHandler(e.id)}),i.find("span.clock-time").text(e.time);var c=i;i.hide().remove(),t("#smslist-table").prepend(c.show())}else null==D&&(D=t.template("smsTableTmpl",t("#smsTableTmpl"))),e.checked=!1,e.newCount=0,e.latestId=e.id,e.latestSms=e.content,e.latestTime=e.time,""!=e.groupId&&void 0!==e.groupId||(e.totalCount=1),e.hasDraft||(e.hasDraft=!1),e.itemId=o,e.name=getNameByNumber(e.number),t.tmpl("smsTableTmpl",{data:[e]}).translate().prependTo("#smslist-table");n.HAS_PHONEBOOK?t(".sms-add-contact-icon").removeClass("hide"):t(".sms-add-contact-icon").addClass("hide"),t("#smslist-table").translate(),renderCheckbox()}}function b(e,s){var n=getLast8Number(s);t("span.smslist-item-name2","#smslist-item-"+n).text(e),t("#listNumber"+n).hide()}function f(e,s){w(),a.deleteMessage({ids:e},function(n){M(null,function(){I(),O()});for(var a=0;a<s.length;a++)g(getPeopleLatestMsg(s[a]),s[a],e.length);synchSmsList(null,e),tryToDisableCheckAll(t("#smslist-checkAll","#smsListForm"),t(".smslist-item","#smslist-table").length)},function(e){O()})}function v(e,s){a.deleteMessage({ids:e},function(n){synchSmsList(null,e),t("#smslist-item-"+s).hide().remove(),N(),tryToDisableCheckAll(t("#smslist-checkAll","#smsListForm"),t(".smslist-item","#smslist-table").length)},function(e){})}function C(){x=1,n.dbMsgs=[],n.listMsgs=null,n.smsMaxId=0,n.phonebook=[],B=!1,shownMsgs=[],G=!1,K=0,P=H=[],F={}}function _(){showLoading("waiting"),n.currentChatObject=null;var e=function(){a.getSMSReady({},function(a){"2"==a.sms_cmd_status_result?(t("input:button","#smsListForm .smslist-btns").attr("disabled","disabled"),hideLoading(),showAlert("sms_init_fail")):"1"==a.sms_cmd_status_result?addTimeout(e,1e3):n.HAS_PHONEBOOK?s():o(!1)})},s=function(){a.getPhoneBookReady({},function(e){"6"==e.pbm_init_flag?o(!1):"0"!=e.pbm_init_flag?addTimeout(s,1e3):o(!0)})},o=function(e){C(),i(e?function(){l(),hideLoading()}:function(){n.phonebook=[],n.HAS_PHONEBOOK||m(),hideLoading()}),bindingEvents(),S(),window.scrollTo(0,0),k()};e()}function k(){var e=t("#smsCapability");M(e),T(),addInterval(function(){M(e),T()},5e3)}function T(){"modem_init_complete"!=a.getStatusInfo().simStatus?(disableBtn(t("#btn-send")),t("#sendSmsErrorLi").html('<span data-trans="no_sim_card_message">'+t.i18n.prop("no_sim_card_message")+"</span>"),t("#chatpanel .smslist-item-resend:visible").hide()):(enableBtn(t("#btn-send")),t("#chatpanel .smslist-item-resend:hidden").show())}function M(e,s){a.getSmsCapability({},function(n){null!=e&&e.text("("+(n.nvUsed>n.nvTotal?n.nvTotal:n.nvUsed)+"/"+n.nvTotal+")"),z=n.nvUsed<n.nvTotal,j=n,t.isFunction(s)&&s()})}function L(){_()}function N(){M(t("#smsCapability")),addTimeout(function(){z||showAlert("sms_capacity_is_full_for_send")},2e3)}function I(){var e=t("#chat-input","#smsChatRoom").val();if(z){var s=getSelectValFromChosen(t(".search-choice","#chosenUserSelect_chzn")),a=!s||0==s.length,o=void 0!==e&&""!=e&&e!=t.i18n.prop("chat_input_placehoder");if(!o)return void n.resetContentModifyValue();if(o&&!a)return n.CONTENT_MODIFIED.modified=!0,n.CONTENT_MODIFIED.message="sms_to_save_draft",n.CONTENT_MODIFIED.callback.ok=y,n.CONTENT_MODIFIED.callback.no=t.noop,void(n.CONTENT_MODIFIED.data={content:t("#chat-input","#smsChatRoom").val(),numbers:s});if(o&&a)return n.CONTENT_MODIFIED.modified=!0,n.CONTENT_MODIFIED.message="sms_no_recipient",n.CONTENT_MODIFIED.callback.ok=t.noop,void(n.CONTENT_MODIFIED.callback.no=function(){return!0})}else n.resetContentModifyValue()}function y(e){function s(e){a.getSMSMessages({page:0,smsCount:5,nMessageStoreType:1,tags:4,orderBy:"order by id desc"},function(s){if(s.messages&&s.messages.length>0){for(var n="",a="",o="",i=0,r=[];i<s.messages.length;i++){for(var l=s.messages[i],m=0;m<e.length;m++){var c=e[m];0==c.indexOf(l.number)&&(l.number=c)}if(""!=n&&n!=l.groupId)break;if(p(l),""==l.groupId)break;n=l.groupId;var d=getShowNameByNumber(l.number);a+=(0==i?"":";")+d,o+=(0==i?"":";")+d,r.push(l)}if(""==n){var l=s.messages[0];l.hasDraft=!0,g(l)}else{var l=s.messages[0],u=18;"UNICODE"==getEncodeType(a).encodeType&&(u=10),l.draftShowNameTitle=o,l.draftShowName=a.length>u?a.substring(0,u)+"...":a,l.hasDraft=!0,l.totalCount=i,F[n]=r,g(l)}tryToDisableCheckAll(t("#smslist-checkAll","#smsListForm"),t(".smslist-item","#smslist-table").length),successOverlay("sms_save_draft_success")}},function(){})}var n=new Date,o={index:-1,currentTimeString:getCurrentTimeString(n),groupId:e.numbers.length>1?n.getTime():"",message:e.content,numbers:e.numbers};a.saveSMS(o,function(){e.isFromBack?s(e.numbers):successOverlay("sms_save_draft_success")},function(){errorOverlay("sms_save_draft_failed")})}function S(){var e,s=t(".smslist-item");e=s.length>0?s[s.length-1]:s[0],K=e?e.offsetTop:600}function w(){disableBtn(t("#btn-back")),t("a","#left").bind("click",function(){return!1}),t("a","#list-nav").bind("click",function(){return!1})}function O(){enableBtn(t("#btn-back")),t("a","#left").unbind("click"),t("a","#list-nav").unbind("click")}var x=1,B=!1,A=!1,E=null,D=null,R=null,U=null,P=[],H=[],F={},j={},z=!0;cleanSmsList=function(){t("#smslist-table").empty()},checkboxClickHandler=function(e){checkDeleteBtnStatus()},getSelectedItem=function(){var e=[];return t("#smslist-table input:checkbox:checked").each(function(s,n){e.push(t(n).val())}),e},checkDeleteBtnStatus=function(){0==getSelectedItem().length?disableBtn(t("#smslist-delete")):enableBtn(t("#smslist-delete"))},refreshClickHandler=function(){t("#smslist-table").empty(),disableBtn(t("#smslist-delete")),disableCheckbox(t("#smslist-checkAll","#smsListForm")),L(),renderCheckbox()},deleteAllClickHandler=function(){showConfirm("confirm_data_delete",function(){showLoading("deleting"),a.deleteAllMessages({location:"native_inbox"},function(e){cleanSmsList(),tryToDisableCheckAll(t("#smslist-checkAll","#smsListForm"),0),successOverlay()},function(e){errorOverlay(e.errorText)})})},deleteSelectClickHandler=function(){function s(s){var a=s.ids,o=[];t.each(n.dbMsgs,function(e,n){-1!=t.inArray(n.id,s.normalIds)&&o.push(n.number)}),o=e.uniq(o),t.each(o,function(e,s){t("#smslist-item-"+getLast8Number(s)).hide().remove()}),t.each(s.groups,function(e,s){t("#smslist-item-"+s).hide().remove()}),synchSmsList(o,a)}function o(){var s=[],a=[],o=[],i=[],r=getSelectedItem();return t.each(r,function(e,n){var a=t("#checkbox"+n);a.attr("groupid")?i.push(a.attr("groupid")):s.push(getLast8Number(a.attr("number")))}),t.each(n.dbMsgs,function(n,r){-1==t.inArray(getLast8Number(r.number),s)||void 0!==r.groupId&&!e.isEmpty(r.groupId+"")?-1!=t.inArray(r.groupId+"",i)&&a.push(r.id):(a.push(r.id),o.push(r.id))}),a=e.uniq(a),{ids:a,groups:i,normalIds:o}}showConfirm("confirm_sms_delete",function(){showLoading("deleting");var e=o();a.deleteMessage({ids:e.ids},function(n){s(e),disableBtn(t("#smslist-delete")),t("#checkbox-all").removeAttr("checked"),renderCheckbox(),successOverlay()},function(e){errorOverlay(e.errorText)})})},newMessageClickHandler=function(){t("#chosenUser1","#smsChatRoom").addClass("hide"),t("#chosenUser","#smsChatRoom").show(),cleanChatInput(),N(),t("select.chzn-select-deselect").val("").trigger("liszt:updated"),h("chat"),gotoBottom(),clearChatList()},chatCancelClickHandler=function(e){if(n.CONTENT_MODIFIED.modified){var s="sms_to_save_draft",a=syncSelectAndChosen(t("select#chosenUserSelect"),t(".search-choice","#chosenUserSelect_chzn")),o=!a||0==a.length;if(o&&(s="sms_no_recipient"),o)showConfirm(s,{ok:function(){o||y({content:t("#chat-input","#smsChatRoom").val(),numbers:a,isFromBack:!0}),n.resetContentModifyValue(),u(e)},no:function(){if(o)return!0;n.resetContentModifyValue(),u(e)}});else{if(syncSelectAndChosen(t("select#chosenUserSelect"),t(".search-choice","#chosenUserSelect_chzn")).length+j.nvUsed>j.nvTotal)return void showAlert({msg:"sms_capacity_will_full_just_draft",params:[j.nvTotal-j.nvUsed]});y({content:t("#chat-input","#smsChatRoom").val(),numbers:a,isFromBack:!0}),n.resetContentModifyValue(),u(e)}return!1}u(e)};var W=null;addSendSmsError=function(e){W&&(window.clearTimeout(W),W=null),t("#sendSmsErrorLi").text(t.i18n.prop(e)),W=addTimeout(function(){t("#sendSmsErrorLi").text("")},5e3)},sendSmsClickHandler=function(){if(!z)return void showAlert("sms_capacity_is_full_for_send");var s=t("#chat-input","#smsChatRoom"),o=s.val();o==t.i18n.prop("chat_input_placehoder")&&(s.val(""),o="");var i=syncSelectAndChosen(t("select#chosenUserSelect"),t(".search-choice","#chosenUserSelect_chzn"));if(t.isArray(i)&&(i=t.grep(i,function(t,s){return!e.isEmpty(t)})),!i||0==i.length)return void addSendSmsError("sms_contact_required");if(i.length+j.nvUsed>j.nvTotal)return void showAlert({msg:"sms_capacity_will_full_just",params:[j.nvTotal-j.nvUsed]});1==i.length?(n.currentChatObject=getLast8Number(i[0]),showLoading("sending")):i.length>1&&(showLoading("sending","<button id='sms_cancel_sending' onclick='cancelSending()' class='btn btn-primary'>"+t.i18n.prop("sms_stop_sending")+"</button>"),n.currentChatObject=null);var r=0,l=i.length;q=!0,disableBtn(t("#btn-send","#inputpanel")),sendSms=function(){if(!q)return void hideLoading();var e={id:-1,number:i[r],content:o,isNew:!1};1==l&&t("#loading #loading_container").html(""),l--,a.sendSMS({number:e.number,message:e.content,id:-1},function(s){var a=getLatestMessage()||{id:parseInt(n.smsMaxId,10)+1,time:transUnixTime(t.now()),number:e.number};if(n.smsMaxId=a.id,e.id=n.smsMaxId,e.time=a.time,e.tag=2,e.hasDraft=!1,i.length>1&&(e.targetName=getNameOrNumberByNumber(e.number)),addSendMessage(e,r+1!=i.length),p(e),g(e),tryToDisableCheckAll(t("#smslist-checkAll","#smsListForm"),t(".smslist-item","#smslist-table").length),gotoBottom(),r+1==i.length)return updateChatInputWordLength(),enableBtn(t("#btn-send","#inputpanel")),void hideLoading();r++,sendSms()},function(s){var a=getLatestMessage()||{id:parseInt(n.smsMaxId,10)+1,time:transUnixTime(t.now()),number:e.number};if(n.smsMaxId=a.id,e.id=n.smsMaxId,e.time=a.time,e.errorText=t.i18n.prop(s.errorText),e.tag=3,e.target=e.number,e.hasDraft=!1,i.length>1&&(e.targetName=getNameOrNumberByNumber(e.number)),addSendMessage(e,r+1!=i.length),p(e),g(e),tryToDisableCheckAll(t("#smslist-checkAll","#smsListForm"),t(".smslist-item","#smslist-table").length),gotoBottom(),r+1==i.length)return updateChatInputWordLength(),enableBtn(t("#btn-send","#inputpanel")),void hideLoading();r++,sendSms()})},sendSms()};var q=!0;cancelSending=function(){q=!1,t("#loading #loading_container").html(t.i18n.prop("sms_cancel_sending"))},getLatestMessage=function(){var e=a.getSMSMessages({page:0,smsCount:5,nMessageStoreType:1,tags:10,orderBy:"order by id desc"});if(e.messages.length>0){for(var t=0;t<e.messages.length;t++)if("2"==e.messages[t].tag||"3"==e.messages[t].tag)return e.messages[t];return null}return null},addSendMessage=function(e,s){null==U&&(U=t.template("smsMeTmpl",t("#smsMeTmpl"))),t.tmpl("smsMeTmpl",e).appendTo("#chatlist"),t("#chatlist").translate(),s||cleanChatInput(),clearMySmsErrorMessage(e.id)},clearMySmsErrorMessage=function(e){addTimeout(function(){t("div.error","#talk-item-"+e).text("")},3e3)};var V=!1;hidePopup=function(){t(".tagPopup").remove(),V=!1},clearChatList=function(){t("#chatlist").empty(),updateChatInputWordLength()},dealContent=function(e){return n.HAS_PHONEBOOK?HTMLEncode(e).replace(/(\d{3,})/g,function(e){var t=((new Date).getTime()+"").substring(6)+(getRandomInt(1e3)+1e3);return"<a id='aNumber"+t+"' href='javascript:openPhoneBook(\""+t+'", "'+e+"\")'>"+e+"</a>"}):HTMLEncode(e)},openPhoneBook=function(e,s){var n=null,a="",o=null,i=!1;e?(n=t("#aNumber"+e),a=".msg_container",o=t("#chatlist"),i=!0):(n=t("#listNumber"+getLast8Number(s)),a=".smslist-item",o=t("#addPhonebookContainer")),V&&hidePopup(),V=!0,t("#tagPopup").remove(),null==E&&(E=t.template("addPhonebookTmpl",t("#addPhonebookTmpl"))),t.tmpl("addPhonebookTmpl",{number:s}).appendTo(o);var r=n.position(),l=n.closest(a),m=l.position(),c=0,d=0;if(i){var u=o.width(),h=o.height(),p=t("#innerTagPopup");c=m.left+r.left,d=m.top+r.top+20,p.width()+c>u&&(c=u-p.width()-20),h>100&&p.height()+d>h&&(d=h-p.height()-5)}else c=r.left,d=r.top;t("#innerTagPopup").css({top:d+"px",left:c+"px"}),t("#quickSaveContactForm").translate().validate({submitHandler:function(){quickSaveContact(i)},rules:{name:"name_check",number:"phonenumber_check"}})},quickSaveContact=function(){var e=t(".tagPopup #innerTagPopup #name").val(),s=t(".tagPopup #innerTagPopup #number").val(),o={index:-1,location:1,name:e,mobile_phone_number:s,home_phone_number:"",office_phone_number:"",mail:""},i=a.getDevicePhoneBookCapacity();if(i.pcPbmUsedCapacity>=i.pcPbmTotalCapacity)return showAlert("device_full"),!1;showLoading(),a.savePhoneBook(o,function(t){n.phonebook.push({pbm_name:e,pbm_number:s}),b(e,s),hidePopup(),successOverlay()},function(e){errorOverlay()})},deleteSingleItemClickHandler=function(e,s){function n(e){a.deleteMessage({ids:[e]},function(n){var a=t(".smslist-item-delete","#talk-item-"+e).attr("target");t("#talk-item-"+e).hide().remove(),synchSmsList(null,[e]),g(getPeopleLatestMsg(a),a),s?s():hideLoading(),tryToDisableCheckAll(t("#smslist-checkAll","#smsListForm"),t(".smslist-item","#smslist-table").length)},function(e){s?s():hideLoading()})}s?n(e):showConfirm("confirm_sms_delete",function(){showLoading("deleting"),n(e)})},getCurrentChatObject=function(){var e=t("select.chzn-select-deselect").val();return e?1==e.length?n.currentChatObject=getLast8Number(e):e.length>1&&(n.currentChatObject=null):n.currentChatObject=null,n.currentChatObject},getPeopleLatestMsg=function(e){for(var t=0;t<n.dbMsgs.length;t++)if(!n.dbMsgs[t].groupId&&getLast8Number(n.dbMsgs[t].number)==getLast8Number(e))return n.dbMsgs[t];return null},resendClickHandler=function(e){if(!z)return void showAlert("sms_capacity_is_full_for_send");showLoading("sending"),t("div.error","#talk-item-"+e).text(t.i18n.prop("sms_resending"));for(var s=t("div.smslist-item-resend","#talk-item-"+e).attr("target"),o=t("div.J_content","#talk-item-"+e).text(),i=0;i<n.dbMsgs.length;i++)n.dbMsgs[i].id==e&&(o=n.dbMsgs[i].content);disableBtn(t("#btn-send","#inputpanel"));var r={id:-1,number:s,content:o,isNew:!1};a.sendSMS({number:r.number,message:r.content,id:-1},function(a){var o=getLatestMessage()||{id:parseInt(n.smsMaxId,10)+1,time:transUnixTime(t.now()),number:r.number};n.smsMaxId=o.id,r.id=n.smsMaxId,r.time=o.time,r.tag=2,r.target=o.number,r.targetName=getNameOrNumberByNumber(s),p(r),g(r),deleteSingleItemClickHandler(e,function(){addSendMessage(r,!0),updateChatInputWordLength(),enableBtn(t("#btn-send","#inputpanel")),hideLoading(),gotoBottom()})},function(a){var o=getLatestMessage()||{id:parseInt(n.smsMaxId,10)+1,time:transUnixTime(t.now()),number:r.number};n.smsMaxId=o.id,r.id=n.smsMaxId,r.time=o.time,r.errorText=t.i18n.prop("sms_resend_fail"),r.tag=3,r.target=o.number,r.targetName=getNameOrNumberByNumber(s),p(r),g(r),deleteSingleItemClickHandler(e,function(){addSendMessage(r,!0),updateChatInputWordLength(),enableBtn(t("#btn-send","#inputpanel")),hideLoading(),gotoBottom()})})},gotoBottom=function(){t("#chatpanel .clear-container").animate({scrollTop:t("#chatlist").height()})};var K=0,G=!1;return bindingEvents=function(){var e=t(window),s=t("#smslist-main .smslist-btns"),n=t("#mainContainer").offset().top;e.unbind("scroll").scroll(function(){e.scrollTop()>n?s.addClass("smsListFloatButs marginnone"):s.removeClass("smsListFloatButs marginnone")}),t("#smslist-table p.checkbox").die().live("click",function(){checkboxClickHandler(t(this).attr("id"))}),t("#smslist-checkAll","#smsListForm").die().live("click",function(){checkDeleteBtnStatus()}),t("#chat-input","#smsChatRoom").die().live("drop",function(){t("#inputpanel .chatform").addClass("chatformfocus");var e=t(this);e.removeAttr("data-trans"),e.val()==t.i18n.prop("chat_input_placehoder")&&e.val(""),updateChatInputWordLength()}).live("focusin",function(){t("#inputpanel .chatform").addClass("chatformfocus");var e=t(this);e.removeAttr("data-trans"),e.val()==t.i18n.prop("chat_input_placehoder")&&e.val(""),updateChatInputWordLength()}).live("focusout",function(){t("#inputpanel .chatform").removeClass("chatformfocus");var e=t(this);""!=e.val()&&e.val()!=t.i18n.prop("chat_input_placehoder")||e.val(t.i18n.prop("chat_input_placehoder")).attr("data-trans","chat_input_placehoder"),updateChatInputWordLength()}).live("keyup",function(){updateChatInputWordLength()}).live("paste",function(){window.setTimeout(function(){updateChatInputWordLength()},0)}).live("cut",function(){window.setTimeout(function(){updateChatInputWordLength()},0)}).live("drop",function(){window.setTimeout(function(){updateChatInputWordLength()},0)}).live("contextmenu",function(){return!1}),t("select.chzn-select-deselect","#smsChatRoom").die().live("change",function(){I()})},getShowNameByNumber=function(e){for(var t=0;t<n.phonebook.length;t++)if(getLast8Number(n.phonebook[t].pbm_number)==getLast8Number(e))return n.phonebook[t].pbm_name+"/"+e;return e},getNameByNumber=function(e){for(var t=0;t<n.phonebook.length;t++)if(getLast8Number(n.phonebook[t].pbm_number)==getLast8Number(e))return n.phonebook[t].pbm_name;return""},getNameOrNumberByNumber=function(e){for(var t=0;t<n.phonebook.length;t++)if(n.phonebook[t].pbm_number==e)return n.phonebook[t].pbm_name;for(var t=0;t<n.phonebook.length;t++)if(getLast8Number(n.phonebook[t].pbm_number)==getLast8Number(e))return n.phonebook[t].pbm_name;return e},smsItemClickHandler=function(s){if(A)return!1;A=!0,null==R&&(R=t.template("smsOtherTmpl",t("#smsOtherTmpl"))),null==U&&(U=t.template("smsMeTmpl",t("#smsMeTmpl")));var a=getShowNameByNumber(s);t("#chosenUser","#smsChatRoom").hide(),t("#chosenUser1","#smsChatRoom").addClass("hide"),n.currentChatObject=getLast8Number(s),setAsRead(s),cleanChatInput(),clearChatList();for(var o=t("select.chzn-select-deselect","#smsChatRoom"),i=t("option",o),r=!1,l=0;l<i.length;l++){var m=i[l];if(getLast8Number(m.value)==n.currentChatObject){s=m.value,r=!0;break}}r||o.append("<option value='"+s+"' selected='selected'>"+s+"</option>"),t("select.chzn-select-deselect").val(s).trigger("liszt:updated"),h("chat"),n.dbMsgs=e.sortBy(n.dbMsgs,function(e){return 0-e.id});for(var c=[],d=[],u=[],p=!1,l=n.dbMsgs.length-1;l>=0;l--){var g=n.dbMsgs[l];-1==e.indexOf(u,g.id)&&(getLast8Number(g.number)==n.currentChatObject&&e.isEmpty(g.groupId)?(g.isNew=!1,g.errorText="",g.targetName="","0"==g.tag||"1"==g.tag?(t.tmpl("smsOtherTmpl",g).appendTo("#chatlist"),u.push(g.id),d.push(g)):"2"==g.tag||"3"==g.tag?(t.tmpl("smsMeTmpl",g).appendTo("#chatlist"),u.push(g.id),d.push(g)):"4"==g.tag&&(c.push(g.id),t("#chat-input","#smsChatRoom").val(g.content).removeAttr("data-trans"),updateChatInputWordLength(),p=!0)):(u.push(g.id),d.push(g)))}t("#chatlist").translate(),p?(t("#chosenUser","#smsChatRoom").show(),t("#chosenUser1","#smsChatRoom").addClass("hide")):(t("#chosenUser","#smsChatRoom").hide(),t("#chosenUser1","#smsChatRoom").removeClass("hide").html(a)),n.dbMsgs=d.reverse(),c.length>0?f(c,[s]):N(),T(),gotoBottom(),A=!1},cleanChatInput=function(){t("#chat-input","#smsChatRoom").val(t.i18n.prop("chat_input_placehoder")).attr("data-trans","chat_input_placehoder")},setAsRead=function(e){var s=[];t.each(n.dbMsgs,function(t,n){getLast8Number(n.number)==getLast8Number(e)&&n.isNew&&(s.push(n.id),n.isNew=!1)}),s.length>0&&a.setSmsRead({ids:s},function(s){s.result&&(t("#smslist-item-"+getLast8Number(e)+" .smslist-item-new-count").text("").addClass("hide"),t("#smslist-item-"+getLast8Number(e)).removeClass("font-weight-bold")),t.each(n.listMsgs,function(t,s){s.number==e&&s.newCount>0&&(s.newCount=0)})})},forwardClickHandler=function(e){clearChatList(),n.currentChatObject=null,t("#chosenUser1","#smsChatRoom").addClass("hide"),t("#chosenUser","#smsChatRoom").show();for(var s=0;s<n.dbMsgs.length;s++)if(n.dbMsgs[s].id==e){var a=t("#chat-input","#smsChatRoom");a.val(n.dbMsgs[s].content),setInsertPos(a[0],n.dbMsgs[s].content.length)}updateChatInputWordLength(),t("select.chzn-select-deselect").val("").trigger("liszt:updated"),addTimeout(function(){t("#chosen-search-field-input").focus()},300),h("chat"),gotoBottom()},updateChatInputWordLength=function(){var e=t("#chat-input","#smsChatRoom"),s=e[0],n=e.val(),a=getEncodeType(n),o="UNICODE"==a.encodeType?335:765;if(n.length+a.extendLen>o){for(var i=s.scrollTop,r=getInsertPos(s),l=n.length+a.extendLen-o,m=n.substr(r-l>0?r-l:0,l),c=m.split("").reverse(),d=0,u=0,h=0;h<c.length;h++)if(getEncodeType(c[h]).extendLen>0?d+=2:d++,d>=l){u=h+1;break}var p=r-u;s.value=n.substr(0,p)+n.substr(r),s.value.length>o&&(s.value=s.value.substr(0,o)),setInsertPos(s,p),s.scrollTop=i}var g=0,b=t(s).val(),f={encodeType:"GSM7_default",extendLen:0};b!=t.i18n.prop("chat_input_placehoder")&&(f=getEncodeType(b));var v="UNICODE"==f.encodeType?335:765,C=t("#inputcount","#inputpanel"),_=t("#inputItemCount","#inputpanel");b.length+f.extendLen>=v?(C.addClass("colorRed"),_.addClass("colorRed")):(t("#inputcount","#inputpanel").removeClass("colorRed"),t("#inputItemCount","#inputpanel").removeClass("colorRed")),""!=b&&t.i18n.prop("chat_input_placehoder")!=b&&(g=b.length+f.extendLen),C.html("("+g+"/"+v+")"),_.html("("+getSmsCount(b)+"/5)"),I()},draftSmsItemClickHandler=function(e){if(A)return!1;A=!0;for(var s=F[e],n=[],a=[],o=0;s&&o<s.length;o++)n.push(getLast8Number(s[o].number)),a.push(s[o].id+"");t("#chosenUser","#smsChatRoom").show(),t("#chosenUser1","#smsChatRoom").addClass("hide").html(""),t("select.chzn-select-deselect").val(n).trigger("liszt:updated"),t("#chat-input","#smsChatRoom").val(s[0].content),updateChatInputWordLength(),clearChatList(),h("chat"),gotoBottom(),A=!1,v(a,e),M(null,function(){I()})},deletePhoneMessageClickHandler=function(e){showConfirm("confirm_sms_delete",function(){showLoading("deleting");var s=[];t.each(n.dbMsgs,function(t,n){n.number==e&&s.push(n.id)}),a.deleteMessage({ids:s},function(n){t("#smslist-item-"+getLast8Number(e)).hide().remove(),synchSmsList([e],s),successOverlay(),tryToDisableCheckAll(t("#smslist-checkAll","#smsListForm"),t(".smslist-item","#smslist-table").length)},function(e){errorOverlay(e.errorText)})})},synchSmsList=function(e,s){if(e&&e.length>0&&(n.listMsgs=t.grep(n.listMsgs,function(s,n){return-1==t.inArray(s.number,e)})),s&&s.length>0){var a=[];t.each(n.dbMsgs,function(e,n){-1==t.inArray(n.id,s)&&a.push(n)}),n.dbMsgs=a}},window.smsUtil={changeLocationHandler:function(e){"sim"==t(e).val()?window.location.hash="#sim_messages":window.location.hash="#sms"}},{init:L}});
//# sourceMappingURL=../../sourcemaps/sms/smslist.js.map
